<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Data Kendaraan & Hasil Taksir | e-Taksir</title>
    <link rel="stylesheet" href="HasilTaksir.css" />

    <!-- Konfigurasi & Auth (WAJIB) -->
    <script src="config.js"></script>
    <script src="auth.js"></script>
    <script>
      // Kunci halaman untuk role S A T K E R
      try {
        Auth.protectPage("satker");
      } catch (e) {}
    </script>
  </head>
  <body>
    <div class="main-wrapper">
      <!-- TOP BAR -->
      <div class="top-bar">
        <button class="btn-back" onclick="window.history.back();">
          <svg width="32" height="32" viewBox="0 0 28 28">
            <path
              d="M18 22l-8-8 8-8"
              stroke="#666"
              stroke-width="2.5"
              fill="none"
              stroke-linecap="round"
              stroke-linejoin="round"
            />
          </svg>
        </button>
        <img
          src="Gambar/Kemenkeu.png"
          alt="Logo Kemenkeu"
          class="logo-kemenkeu"
        />
      </div>

      <div class="result-card">
        <h2 class="section-title">Data Kendaraan dan Kondisi Fisik</h2>

        <!-- IDENTITAS -->
        <div class="vehicle-data-box">
          <img src="Gambar/Logo.png" class="logoe" alt="" />
          <div class="vehicle-group" id="vehicleGroup"></div>
        </div>

        <!-- LOOKER (fallback) -->
        <div
          class="dashboard-frame-wrapper"
          style="position: relative; width: 100%; padding-top: 56.25%"
        >
          <iframe
            src="https://lookerstudio.google.com/embed/reporting/77077b9e-8c30-4a7d-911a-458245f4c5b4/page/QZnRF"
            style="
              position: absolute;
              top: 0;
              left: 0;
              width: 100%;
              height: 100%;
              border: 0;
            "
            allowfullscreen
            sandbox="allow-storage-access-by-user-activation allow-scripts allow-same-origin allow-popups allow-popups-to-escape-sandbox"
          >
          </iframe>
        </div>

        <!-- KONTROL TAHAP -->
        <div class="tahap-control">
          <div class="tahap-left">
            <label for="tahapSelect">Cari Data Hasil Lelang</label>
            <div class="tahap-inline">
              <select id="tahapSelect">
                <option value="1">Tahap 1</option>
                <option value="2">Tahap 2</option>
                <option value="3">Tahap 3</option>
                <option value="4">Tahap 4</option>
                <option value="5">Tahap 5</option>
                <option value="6">Tahap 6</option>
                <option value="7">Tahap 7</option>
                <option value="8">Tahap 8</option>
              </select>
              <button id="btnCariTahap" class="btn-tambah">Cari</button>
            </div>
            <div id="tahapInfo" class="tahap-info"></div>
          </div>
        </div>

        <!-- TABEL HASIL LELANG -->
        <div class="table-title">
          <span>Data Hasil Lelang </span>
          <span class="brand-highlight" id="lelangBrand">-</span>
        </div>

        <div class="fit-wrap">
          <table id="tabelHasilLelang" class="no-wrap auto-fit">
            <thead>
              <tr>
                <th>No</th>
                <th style="min-width: 130px">Kode Lelang</th>
                <th>Merek</th>
                <th>Tipe</th>
                <th>Harga Lelang</th>
                <th>Waktu Lelang</th>
                <th>Lokasi</th>
                <th>Kategori Lokasi</th>
                <th>Tahun Pembuatan</th>
                <th class="aksi-header fade-table-col">Aksi</th>
              </tr>
            </thead>
            <tbody id="tbodyPembanding"></tbody>
          </table>
        </div>

        <div class="table-btn-row" id="rowTambahData">
          <button
            class="btn-tambah"
            id="btnTambahManual"
            onclick="tambahManual()"
            style="margin-top: 10px"
          >
            + Tambah Data
          </button>
        </div>

        <!-- PENYESUAIAN -->
        <div class="penyesuaian-section" id="penyesuaianSection">
          <div class="table-title" style="margin-top: 28px">Penyesuaian</div>

          <div class="fit-wrap">
            <table id="tabelPenyesuaian" class="no-wrap auto-fit">
              <thead>
                <tr>
                  <th>No</th>
                  <th>Merek</th>
                  <th>Tipe (%)</th>
                  <th>Merek (%)</th>
                  <th>Waktu (%)</th>
                  <th>Lokasi (%)</th>
                  <th>Tahun Pembuatan (%)</th>
                  <th>Total</th>
                  <th>Nilai Taksiran</th>
                </tr>
              </thead>
              <tbody id="tbodyPenyesuaian"></tbody>
              <tfoot>
                <tr>
                  <td colspan="8" style="text-align: right; font-weight: 800">
                    Nilai Taksiran (Total)&nbsp;
                  </td>
                  <td id="totalTaksiran" style="font-weight: 900">-</td>
                </tr>
              </tfoot>
            </table>
          </div>

          <div class="nilai-row">
            <div class="nilai-box">
              <span class="nilai-label">RATA - RATA NILAI TAKSIRAN</span>
              <span class="nilai-val" id="rataTaksir">-</span>
            </div>
            <div class="nilai-box">
              <span class="nilai-label">TAKSIRAN NILAI LIMIT LELANG</span>
              <span class="nilai-val" id="limitTaksir">-</span>
            </div>
            <div class="nilai-box">
              <span class="nilai-label">PEMBULATAN</span>
              <span class="nilai-val" id="pembulatan">-</span>
            </div>
          </div>

          <div class="btn-simpan-row">
            <button
              class="btn-simpan"
              id="btnSimpanKertasKerja"
              onclick="saveKertasKerjaToExcel()"
            >
              Simpan
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- MODAL KONFIRMASI SIMPAN -->
    <div id="saveModal" class="modal-backdrop" aria-hidden="true">
      <div class="modal">
        <h3>Konfirmasi Simpan</h3>
        <p>Apakah Anda yakin ingin menyimpan kertas kerja ini?</p>
        <div class="modal-actions">
          <button id="btnNo" class="btn-modal">Tidak</button>
          <button id="btnYes" class="btn-modal primary">Ya</button>
        </div>
        <div class="modal-status">
          <div id="modalSpinner" class="spinner"></div>
          <div id="modalCheck" class="checkmark">✓</div>
        </div>
        <div id="modalDesc" class="modal-desc"></div>
      </div>
    </div>

    <script>
      /* ===================== STATE & HELPERS ===================== */
      const API_BASE = (window.API_URL || "").replace(/\/+$/, ""); // tanpa trailing slash
      const SATKER = (() => {
        try {
          return new Auth.ApiClient("satker");
        } catch {
          return null;
        }
      })();

      const $ = (q, el = document) => el.querySelector(q);
      const $$ = (q, el = document) => Array.from(el.querySelectorAll(q));
      const fmtIDR = (n) => (isFinite(n) ? n.toLocaleString("id-ID") : "-");

      // data input dari halaman index
      const inputLelang = JSON.parse(
        sessionStorage.getItem("dataKertasKerja") || "{}"
      );

      // ID draft per flow
      const FLOW_KEY = "kk_flow_id";
      let flowId = sessionStorage.getItem(FLOW_KEY);
      if (!flowId) {
        flowId = Date.now() + "-" + Math.random().toString(36).slice(2, 8);
        sessionStorage.setItem(FLOW_KEY, flowId);
      }
      const draftKey = "kk_draft_" + flowId;

      let dataPembanding = []; // [{KodeLelang, Merek, ...}]
      let dataLelangByKode = {}; // cache

      // tampil fallback value
      const isi = (v, fb = "-") =>
        Array.isArray(v) ? (v.length ? v.join(", ") : fb) : v ?? fb;

      // tampilkan dokumen kepemilikan, jika "Lainnya" gunakan detailnya
      function formatDokumenKepemilikan() {
        const arr = inputLelang?.dokumen_kepemilikan;
        const lain = (inputLelang?.dok_lainnya_detail || "").trim();
        if (Array.isArray(arr) && arr.length) {
          return arr
            .map((x) => (x === "Lainnya" && lain ? lain : x))
            .join(", ");
        }
        return isi(arr);
      }

      // ambil angka faktor dari deskripsi dropdown kondisi (0,5/0,6/0,7)
      const getKondisiFactor = (str) => {
        if (!str) return 0.6;
        const m = String(str)
          .replace(",", ".")
          .match(/[0-9.]+/);
        const f = m ? parseFloat(m[0]) : 0.6;
        return Number.isFinite(f) ? f : 0.6;
      };
      let currentKondisiFactor = getKondisiFactor(
        inputLelang.kondisi_kendaraan
      );

      // normalisasi baris data hasil lelang dari API manapun
      function normalizeRow(x = {}) {
        const pick = (a, ...alts) =>
          a !== undefined ? a : alts.find((v) => v !== undefined);
        const KodeLelang = pick(
          x.KodeLelang,
          x.kode_lelang,
          x.Kode,
          x.kode,
          x["Kode Lelang"]
        );
        const Merek = pick(x.Merek, x.merek, x.Merk, x.merk);
        const Tipe = pick(x.Tipe, x.tipe, x.Model, x.model);
        const HargaLelang =
          +String(
            pick(x.HargaLelang, x.harga_lelang, x.harga, x["Harga Lelang"], 0)
          ).replace(/\D/g, "") || 0;
        const TahunTransaksi = pick(
          x.TahunTransaksi,
          x.tahun_transaksi,
          x.tahun,
          x["Waktu Lelang"]
        );
        const Lokasi = pick(x.Lokasi, x.lokasi, x.kota);
        const KategoriLokasi = pick(
          x.KategoriLokasi,
          x.kategori_lokasi,
          x["Kategori Lokasi"]
        );
        const TahunPembuatan = pick(
          x.TahunPembuatan,
          x.tahun_pembuatan,
          x["Tahun Pembuatan"]
        );
        return {
          KodeLelang,
          Merek,
          Tipe,
          HargaLelang,
          TahunTransaksi,
          Lokasi,
          KategoriLokasi,
          TahunPembuatan,
        };
      }

      /* ===================== RENDER IDENTITAS ===================== */
      $("#vehicleGroup").innerHTML = `
        <h2>IDENTIFIKASI</h2>
        <div class="row">
          <div class="field"><label>NAMA OBJEK</label><div class="val">${isi(
            inputLelang.nama_objek
          )}</div></div>
          <div class="field"><label>NUP</label><div class="val">${isi(
            inputLelang.nup
          )}</div></div>
        </div>
        <div class="row">
          <div class="field"><label>LOKASI OBJEK</label><div class="val">${isi(
            inputLelang.lokasi_objek
          )}</div></div>
          <div class="field"><label>KATEGORI LOKASI</label><div class="val">${isi(
            inputLelang.kategori_lokasi
          )}</div></div>
        </div>
        <div class="row">
          <div class="field"><label>JENIS KENDARAAN</label><div class="val">${isi(
            inputLelang.jenis_kendaraan
          )}</div></div>
          <div class="field"><label>MERK KENDARAAN</label><div class="val">${isi(
            inputLelang.merek_kendaraan
          )}</div></div>
          <div class="field"><label>TIPE KENDARAAN</label><div class="val">${isi(
            inputLelang.tipe_kendaraan
          )}</div></div>
        </div>
        <div class="sub-group">
          <div class="sub-label">Identitas Kendaraan</div>
          <div class="row">
            <div class="field"><label>NOMOR POLISI</label><div class="val">${isi(
              inputLelang.nomor_polisi
            )}</div></div>
            <div class="field"><label>DOKUMEN KEPEMILIKAN</label><div class="val">${formatDokumenKepemilikan()}</div></div>
          </div>
        </div>
        <div class="row">
          <div class="field"><label>PEMILIK DOKUMEN</label><div class="val">${isi(
            inputLelang.pemilik_dokumen
          )}</div></div>
          <div class="field"><label>MASA BERLAKU</label><div class="val">${isi(
            inputLelang.masa_berlaku
          )}</div></div>
        </div>
        <div class="sub-group">
          <div class="sub-label">Keterangan</div>
          <div class="row">
            <div class="field"><label>PENGGUNAAN KENDARAAN</label><div class="val">${isi(
              inputLelang.penggunaan_kendaraan
            )}</div></div>
            <div class="field"><label>KETERANGAN LAINNYA</label><div class="val">${isi(
              inputLelang.keterangan_lain || inputLelang.keterangan
            )}</div></div>
          </div>
        </div>
        <h2>FISIK KENDARAAN</h2>
        <div class="row">
          <div class="field"><label>WARNA</label><div class="val">${isi(
            inputLelang.warna
          )}</div></div>
          <div class="field"><label>TAHUN PEMBUATAN</label><div class="val">${isi(
            inputLelang.tahun_pembuatan
          )}</div></div>
          <div class="field"><label>BAHAN BAKAR</label><div class="val">${isi(
            inputLelang.bahan_bakar
          )}</div></div>
        </div>
        <div class="row">
          <div class="field" style="flex:2;"><label>KONDISI KENDARAAN</label><div class="val">${isi(
            inputLelang.kondisi_kendaraan
          )}</div></div>
        </div>`;
      $("#lelangBrand").textContent = isi(inputLelang.merek_kendaraan);

      /* ===================== FIT (no scroll, no wrap) ===================== */
      function debounce(fn, wait = 120) {
        let t;
        return (...a) => {
          clearTimeout(t);
          t = setTimeout(() => fn(...a), wait);
        };
      }
      function autoFitTable(tableEl) {
        if (!tableEl) return;
        const wrap = tableEl.closest(".fit-wrap") || tableEl.parentElement;
        tableEl.classList.remove("is-scaling");
        tableEl.style.transform = "none";
        wrap.style.height = "";
        const wrapW = Math.max(1, wrap.clientWidth);
        const tableW = tableEl.scrollWidth;
        const scale = Math.min(1, wrapW / tableW);
        if (scale < 1) {
          tableEl.classList.add("is-scaling");
          tableEl.style.transform = `scale(${scale})`;
          const rect = tableEl.getBoundingClientRect();
          wrap.style.height = `${rect.height}px`;
        } else {
          wrap.style.height = `${tableEl.offsetHeight}px`;
        }
      }
      const autoFitAll = () => $$(".auto-fit").forEach(autoFitTable);
      window.addEventListener("load", autoFitAll);
      window.addEventListener("resize", debounce(autoFitAll, 120));

      /* ===================== TABEL HASIL LELANG ===================== */
      function kodeLelangCellHTML(value = "", mode = "manual") {
        const val = (value || "").toString().toUpperCase();
        if (mode === "auto") {
          return `<div class="kode-wrap">
            <input type="text" class="kode-input" value="${val}" maxlength="6" readonly style="background:#f6f7fb;cursor:not-allowed"/>
          </div>`;
        }
        return `<div class="kode-wrap">
          <input type="text" class="kode-input" maxlength="6" placeholder="KETIK & ENTER"
            value="${val}"
            oninput="this.value=this.value.toUpperCase().replace(/[^A-Z0-9]/g,'')"
            onkeydown="if(event.key==='Enter'){event.preventDefault(); triggerAmbilKode(this);}"/>
          <button class="kode-check" ${
            val.length === 6 ? "" : "disabled"
          } title="Ambil data">✔</button>
        </div>`;
      }

      function renderPembanding() {
        const tb = $("#tbodyPembanding");
        tb.innerHTML = "";
        if (!dataPembanding.length) {
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>1</td>
            <td>${kodeLelangCellHTML("", "manual")}</td>
            <td class="merek"></td><td class="tipe"></td><td class="harga"></td>
            <td class="waktu"></td><td class="lokasi"></td><td class="kategori"></td><td class="tahun"></td>
            <td class="fade-table-col aksi-cell"><button class="btn-hapus" onclick="hapusBaris(this)">Hapus</button></td>`;
          tb.appendChild(tr);
          buildPenyesuaianFromPembanding();
          recalcAll();
          autoFitAll();
          saveDraft();
          return;
        }
        dataPembanding.forEach((d, i) => {
          const tr = document.createElement("tr");
          const mode = d.manual ? "manual" : "auto";
          tr.innerHTML = `
            <td>${i + 1}</td>
            <td>${kodeLelangCellHTML(d.KodeLelang || "", mode)}</td>
            <td class="merek">${d.Merek || "-"}</td>
            <td class="tipe">${d.Tipe || "-"}</td>
            <td class="harga">${
              d.HargaLelang ? "Rp " + fmtIDR(+d.HargaLelang) : "-"
            }</td>
            <td class="waktu">${d.TahunTransaksi || "-"}</td>
            <td class="lokasi">${d.Lokasi || "-"}</td>
            <td class="kategori">${d.KategoriLokasi || "-"}</td>
            <td class="tahun">${d.TahunPembuatan || "-"}</td>
            <td class="fade-table-col aksi-cell"><button class="btn-hapus" onclick="hapusBaris(this)">Hapus</button></td>`;
          tb.appendChild(tr);
        });
        buildPenyesuaianFromPembanding();
        recalcAll();
        autoFitAll();
        saveDraft();
      }

      function tambahManual() {
        if ($("#tbodyPembanding").rows.length >= 7) {
          alert("Maksimal 7 data.");
          return;
        }
        const tr = document.createElement("tr");
        tr.classList.add("fade-in-row");
        tr.innerHTML = `
          <td></td><td>${kodeLelangCellHTML("", "manual")}</td>
          <td class="merek"></td><td class="tipe"></td><td class="harga"></td>
          <td class="waktu"></td><td class="lokasi"></td><td class="kategori"></td><td class="tahun"></td>
          <td class="fade-table-col aksi-cell"><button class="btn-hapus" onclick="hapusBaris(this)">Hapus</button></td>`;
        $("#tbodyPembanding").appendChild(tr);
        updateTableNumbers();
        autoFitAll();
      }

      function updateTableNumbers() {
        $$("#tbodyPembanding tr").forEach((tr, i) => {
          const no = tr.querySelector("td:first-child");
          if (no) no.textContent = i + 1;
        });
      }

      function hapusBaris(btn) {
        const row = btn.closest("tr");
        const idx = Array.from($("#tbodyPembanding").rows).indexOf(row);
        if (idx > -1) dataPembanding.splice(idx, 1);
        row.remove();
        updateTableNumbers();
        buildPenyesuaianFromPembanding();
        recalcAll();
        autoFitAll();
        saveDraft();
      }

      /* ===================== AMBIL DATA BY KODE ===================== */
      async function fetchByKode(kode) {
        const res = await fetch(`${API_BASE}/kertas-kerja/lelang/${kode}`, {
          headers: SATKER ? SATKER.headers() : {},
        });
        if (!res.ok) throw new Error("HTTP " + res.status);
        const j = await res.json().catch(() => ({}));
        const raw = j?.data || null;
        return raw ? normalizeRow(raw) : null;
      }
      async function triggerAmbilKode(inputEl) {
        const row = inputEl.closest("tr");
        const btn = row.querySelector(".kode-check");
        if (inputEl.value.trim().length === 6 && !btn.disabled) btn.click();
      }

      const tbodyPemb = $("#tbodyPembanding");
      tbodyPemb.addEventListener("input", (e) => {
        const el = e.target;
        if (!el.classList.contains("kode-input")) return;
        const row = el.closest("tr");
        const btn = row.querySelector(".kode-check");
        const kode = (el.value || "").trim().toUpperCase();
        el.value = kode;
        const duplicate = Array.from(tbodyPemb.querySelectorAll(".kode-input"))
          .filter((x) => x !== el)
          .some(
            (x) =>
              (x.value || "").trim().toUpperCase() === kode && kode.length === 6
          );
        btn.disabled = !(kode.length === 6 && !duplicate);
      });

      tbodyPemb.addEventListener("click", async (e) => {
        const btn = e.target.closest(".kode-check");
        if (!btn) return;
        const row = btn.closest("tr");
        const input = row.querySelector(".kode-input");
        const kode = (input.value || "").trim().toUpperCase();
        if (kode.length !== 6) {
          alert("Kode lelang harus 6 karakter.");
          return;
        }
        const duplicate = Array.from(tbodyPemb.querySelectorAll(".kode-input"))
          .filter((x) => x !== input)
          .some((x) => (x.value || "").trim().toUpperCase() === kode);
        if (duplicate) {
          alert("Kode lelang sudah ada di tabel.");
          return;
        }

        btn.disabled = true;
        try {
          let d = dataLelangByKode[kode];
          if (!d) d = await fetchByKode(kode);
          if (!d || !d.KodeLelang) {
            alert("Kode lelang tidak ditemukan. Silakan input ulang.");
            btn.disabled = false;
            return;
          }
          row.querySelector(".merek").textContent = d.Merek || "-";
          row.querySelector(".tipe").textContent = d.Tipe || "-";
          row.querySelector(".harga").textContent = d.HargaLelang
            ? "Rp " + fmtIDR(+d.HargaLelang)
            : "-";
          row.querySelector(".waktu").textContent = d.TahunTransaksi || "-";
          row.querySelector(".lokasi").textContent = d.Lokasi || "-";
          row.querySelector(".kategori").textContent = d.KategoriLokasi || "-";
          row.querySelector(".tahun").textContent = d.TahunPembuatan || "-";

          const idx = Array.from($("#tbodyPembanding").rows).indexOf(row);
          dataPembanding[idx] = {
            ...(dataPembanding[idx] || {}),
            ...d,
            KodeLelang: kode,
            manual: true,
            verified: true,
          };
          dataLelangByKode[kode] = d;

          row.children[1].innerHTML = `<div class="kode-wrap"><input type="text" class="kode-input" value="${kode}" maxlength="6" readonly/></div>`;
          buildPenyesuaianFromPembanding();
          recalcAll();
          autoFitAll();
          saveDraft();
        } catch (err) {
          alert("Gagal mengambil data kode lelang. Coba lagi.");
          btn.disabled = false;
        }
      });

      /* ===================== CARI TAHAP ===================== */
      $("#btnCariTahap").addEventListener("click", async () => {
        const tahap = +$("#tahapSelect").value;
        await cariPembandingTahap(tahap);
      });

      async function cariPembandingTahap(tahap) {
        $("#tahapInfo").textContent = `Memproses Tahap ${tahap}…`;
        try {
          const res = await fetch(`${API_BASE}/kertas-kerja/${tahap}`, {
            method: "POST",
            headers: SATKER
              ? SATKER.headers({ "Content-Type": "application/json" })
              : { "Content-Type": "application/json" },
            body: JSON.stringify({
              merek_kendaraan: inputLelang.merek_kendaraan,
              tipe_kendaraan: inputLelang.tipe_kendaraan,
              tahun_pembuatan: parseInt(inputLelang.tahun_pembuatan),
              lokasi_objek: inputLelang.lokasi_objek,
              kategori_lokasi: inputLelang.kategori_lokasi,
              provinsi: inputLelang.provinsi,
            }),
          });
          const j = await res.json().catch(() => ({}));
          const arr = j?.data?.data_pembanding || [];

          let pushed = 0;
          arr.forEach((raw) => {
            const x = normalizeRow(raw);
            if (!x.KodeLelang) return;
            if ($("#tbodyPembanding").rows.length >= 7) return;
            if (dataPembanding.find((d) => d.KodeLelang === x.KodeLelang))
              return;
            dataPembanding.push({ ...x, manual: false });
            dataLelangByKode[x.KodeLelang] = x;
            pushed++;
          });

          renderPembanding();
          const len = $("#tbodyPembanding").rows.length;
          $("#tahapInfo").textContent =
            `Tahap ${tahap}: ditambahkan ${pushed} data. Total baris ${len} (butuh 3–7).` +
            (len < 3 || len > 7
              ? " Silakan pilih tahap lain atau tambah manual."
              : "");
        } catch (e) {
          $("#tahapInfo").textContent = "Gagal memproses. Coba lagi.";
        }
      }

      /* ===================== PENYESUAIAN ===================== */
      function buildPenyesuaianFromPembanding() {
        const dest = $("#tbodyPenyesuaian");
        dest.innerHTML = "";
        dataPembanding.forEach((d, i) => {
          const row = document.createElement("tr");
          row.innerHTML = `
            <td>${i + 1}</td>
            <td class="peny-merek">${d.Merek || "-"}</td>
            <td><input class="peny-input pct" data-col="tipe"   inputmode="numeric" placeholder="0%"></td>
            <td><input class="peny-input pct" data-col="merek"  inputmode="numeric" placeholder="0%"></td>
            <td><input class="peny-input pct" data-col="waktu"  inputmode="numeric" placeholder="0%"></td>
            <td><input class="peny-input pct" data-col="lokasi" inputmode="numeric" placeholder="0%"></td>
            <td><input class="peny-input pct" data-col="tahun"  inputmode="numeric" placeholder="0%"></td>
            <td class="peny-total">0%</td>
            <td class="peny-nilai">-</td>`;
          dest.appendChild(row);
        });

        $$("#tbodyPenyesuaian .pct").forEach((inp) => {
          inp.addEventListener("focus", (e) => {
            const v = e.target.value.trim();
            if (v.endsWith("%")) e.target.value = v.slice(0, -1);
          });
          inp.addEventListener("input", (e) => {
            let val = e.target.value;
            const isNeg = val.startsWith("-");
            val = val.replace(/[^0-9]/g, "").slice(0, 2);
            e.target.value = (isNeg ? "-" : "") + val;
            recalcAll();
          });
          inp.addEventListener("blur", (e) => {
            const n = pctToNumber(e.target.value);
            e.target.value = e.target.value === "" ? "" : n + "%";
            recalcAll();
          });
        });

        restorePctFromDraft();
        autoFitAll();
      }

      const pctToNumber = (v) => {
        if (v == null || v === "") return 0;
        const m = String(v).match(/-?\d+/);
        if (!m) return 0;
        const n = parseInt(m[0], 10);
        return Math.max(-99, Math.min(99, n));
      };
      const roundToThousand = (n) => Math.round((+n || 0) / 1000) * 1000;

      function recalcAll() {
        const rows = $$("#tbodyPenyesuaian tr");
        let nilaiList = [];
        rows.forEach((r, i) => {
          const tipe = pctToNumber(r.querySelector('[data-col="tipe"]')?.value);
          const merek = pctToNumber(
            r.querySelector('[data-col="merek"]')?.value
          );
          const waktu = pctToNumber(
            r.querySelector('[data-col="waktu"]')?.value
          );
          const lokasi = pctToNumber(
            r.querySelector('[data-col="lokasi"]')?.value
          );
          const tahun = pctToNumber(
            r.querySelector('[data-col="tahun"]')?.value
          );
          const totalPct = tipe + merek + waktu + lokasi + tahun;
          r.querySelector(".peny-total").textContent = totalPct + "%";

          const harga =
            Number(
              (dataPembanding[i]?.HargaLelang || "0")
                .toString()
                .replace(/\D/g, "")
            ) || 0;
          const nilaiTaksiran = Math.round(harga * (1 + totalPct / 100));
          r.querySelector(".peny-nilai").textContent = nilaiTaksiran
            ? "Rp " + fmtIDR(nilaiTaksiran)
            : "-";
          if (nilaiTaksiran !== 0) nilaiList.push(nilaiTaksiran);
        });

        const sum = nilaiList.reduce((a, b) => a + b, 0);
        const avg = nilaiList.length ? Math.round(sum / nilaiList.length) : 0;
        const limit = Math.round(avg * currentKondisiFactor);
        const bulat = roundToThousand(limit);

        $("#totalTaksiran").textContent = nilaiList.length
          ? "Rp " + fmtIDR(sum)
          : "-";
        $("#rataTaksir").textContent = nilaiList.length
          ? "Rp " + fmtIDR(avg)
          : "-";
        $("#limitTaksir").textContent = nilaiList.length
          ? "Rp " + fmtIDR(limit)
          : "-";
        $("#pembulatan").textContent = nilaiList.length
          ? "Rp " + fmtIDR(bulat)
          : "-";

        saveDraft();
      }

      /* ===================== DRAFT ===================== */
      function readPenyesuaianEditsForDraft() {
        return Array.from($("#tbodyPenyesuaian").rows).map((r) => ({
          tipe: r.querySelector('[data-col="tipe"]')?.value || "",
          merek: r.querySelector('[data-col="merek"]')?.value || "",
          waktu: r.querySelector('[data-col="waktu"]')?.value || "",
          lokasi: r.querySelector('[data-col="lokasi"]')?.value || "",
          tahun: r.querySelector('[data-col="tahun"]')?.value || "",
        }));
      }
      function restorePctFromDraft() {
        const raw = sessionStorage.getItem(draftKey);
        if (!raw) return;
        let draft;
        try {
          draft = JSON.parse(raw);
        } catch {
          return;
        }
        if (!Array.isArray(draft?.penyesuaian)) return;
        const rows = $$("#tbodyPenyesuaian tr");
        draft.penyesuaian.forEach((p, i) => {
          const r = rows[i];
          if (!r) return;
          ["tipe", "merek", "waktu", "lokasi", "tahun"].forEach((col) => {
            const el = r.querySelector(`[data-col="${col}"]`);
            if (el && p[col] !== undefined) el.value = p[col];
          });
        });
      }
      function saveDraft() {
        const payload = {
          dataPembanding,
          penyesuaian: readPenyesuaianEditsForDraft(),
          ts: Date.now(),
        };
        sessionStorage.setItem(draftKey, JSON.stringify(payload));
      }
      function tryRestoreFromDraft() {
        const raw = sessionStorage.getItem(draftKey);
        if (!raw) return false;
        let draft;
        try {
          draft = JSON.parse(raw);
        } catch {
          return false;
        }
        if (!Array.isArray(draft?.dataPembanding)) return false;
        dataPembanding = draft.dataPembanding;
        renderPembanding();
        recalcAll();
        return true;
      }

      /* ===================== MODAL ===================== */
      const modal = {
        el: $("#saveModal"),
        yes: $("#btnYes"),
        no: $("#btnNo"),
        spin: $("#modalSpinner"),
        check: $("#modalCheck"),
        desc: $("#modalDesc"),
        open() {
          this.reset();
          this.el.style.display = "flex";
          this.el.removeAttribute("aria-hidden");
          return new Promise((resolve) => {
            const onNo = () => {
              this.close();
              cleanup();
              resolve(false);
            };
            const onYes = () => {
              cleanup();
              resolve(true);
            };
            const cleanup = () => {
              this.no.removeEventListener("click", onNo);
              this.yes.removeEventListener("click", onYes);
            };
            this.no.addEventListener("click", onNo);
            this.yes.addEventListener("click", onYes);
            this.el.addEventListener(
              "click",
              (e) => {
                if (e.target === this.el) onNo();
              },
              { once: true }
            );
          });
        },
        showLoading(text = "Menyimpan kertas kerja…") {
          this.spin.style.display = "inline-block";
          this.desc.style.display = "block";
          this.desc.textContent = text;
          this.yes.disabled = true;
          this.no.disabled = true;
        },
        showSuccess(text = "Berhasil disimpan") {
          this.spin.style.display = "none";
          this.check.style.display = "flex";
          this.desc.style.display = "block";
          this.desc.textContent = text;
        },
        close() {
          this.el.style.display = "none";
          this.el.setAttribute("aria-hidden", "true");
        },
        reset() {
          this.spin.style.display = "none";
          this.check.style.display = "none";
          this.desc.style.display = "none";
          this.yes.disabled = false;
          this.no.disabled = false;
        },
      };

      /* ===================== SIMPAN ===================== */
      function collectPembandingForSave() {
        return Array.from($("#tbodyPembanding").rows).map((tr, i) => {
          const kode = (tr.querySelector(".kode-input")?.value || "")
            .trim()
            .toUpperCase();
          const src = dataPembanding[i] || dataLelangByKode[kode] || {};
          const txt = (sel) =>
            (tr.querySelector(sel)?.textContent || "").trim();

          return {
            kode_lelang: kode || src.KodeLelang || "",
            merek: txt(".merek") || src.Merek || "",
            tipe: txt(".tipe") || src.Tipe || "",
            tahun_pembuatan:
              parseInt(txt(".tahun") || src.TahunPembuatan || 0, 10) || 0,
            lokasi: txt(".lokasi") || src.Lokasi || "",
            kategori_lokasi:
              parseInt(txt(".kategori") || src.KategoriLokasi || 0, 10) || 0,
            harga_lelang:
              parseInt(String(src.HargaLelang ?? "").replace(/\D/g, ""), 10) ||
              0,
            tahun_transaksi:
              parseInt(txt(".waktu") || src.TahunTransaksi || 0, 10) || 0,
          };
        });
      }
      function readPenyesuaianEdits() {
        return Array.from($("#tbodyPenyesuaian").rows).map((r) => ({
          data_hasil_lelang:
            r.querySelector(".peny-merek")?.textContent?.trim() || "",
          tipe: pctToNumber(r.querySelector('[data-col="tipe"]')?.value),
          merek: pctToNumber(r.querySelector('[data-col="merek"]')?.value),
          waktu: pctToNumber(r.querySelector('[data-col="waktu"]')?.value),
          lokasi: pctToNumber(r.querySelector('[data-col="lokasi"]')?.value),
          tahun_pembuatan: pctToNumber(
            r.querySelector('[data-col="tahun"]')?.value
          ),
          total: pctToNumber(r.querySelector(".peny-total")?.textContent),
          nilai_taksiran:
            Number(
              (r.querySelector(".peny-nilai")?.textContent || "").replace(
                /[^\d]/g,
                ""
              )
            ) || 0,
        }));
      }

      async function saveKertasKerjaToExcel() {
        if ($("#tbodyPembanding").rows.length < 3) {
          alert("Data pembanding minimal 3 baris.");
          return;
        }
        const ok = await modal.open();
        if (!ok) return;
        modal.showLoading("Menyimpan kertas kerja…");

        function normalisasiJenisKendaraan(raw) {
          const s = String(raw || "")
            .toLowerCase()
            .trim();
          if (s.includes("roda 2") || s.includes("roda 3")) return "Roda 2";
          return "Roda 4 atau lebih";
        }
        const jenisRaw = (inputLelang.jenis_kendaraan || "").trim();
        const jenisStr =
          jenisRaw === "Roda 2 atau 3" ? "Roda 2 atau 3" : "Roda 4 atau lebih";

        // Normalisasi dokumen juga
        let dokList = Array.isArray(inputLelang.dokumen_kepemilikan)
          ? inputLelang.dokumen_kepemilikan.map((s) => String(s).trim())
          : [];
        if (inputLelang.dokumen_kepemilikan_tidak_ada) {
          dokList = ["Tidak ada"];
        }
        const dokumenLainnya = (
          inputLelang.dok_lainnya_detail ||
          inputLelang.dokumen_lainnya ||
          ""
        ).trim();

        const data_pembanding = collectPembandingForSave();
        const penyesuaian = readPenyesuaianEdits();

        if (penyesuaian.length !== data_pembanding.length) {
          while (penyesuaian.length < data_pembanding.length)
            penyesuaian.push({
              data_hasil_lelang:
                data_pembanding[penyesuaian.length]?.merek || "",
              tipe: 0,
              merek: 0,
              waktu: 0,
              lokasi: 0,
              tahun_pembuatan: 0,
              total: 0,
              nilai_taksiran: 0,
            });
          penyesuaian.length = data_pembanding.length;
        }
        const data_penyesuaian = penyesuaian.map((p) => ({
          data_hasil_lelang: p.data_hasil_lelang || "",
          tipe: Number(p.tipe) || 0,
          merek: Number(p.merek) || 0,
          waktu: Number(p.waktu) || 0,
          lokasi: Number(p.lokasi) || 0,
          tahun_pembuatan: Number(p.tahun_pembuatan) || 0,
          total: Number(p.total) || 0,
          nilai_taksiran: Number(p.nilai_taksiran) || 0,
        }));

        const listNilai = penyesuaian
          .map((x) => Number(x.nilai_taksiran) || 0)
          .filter((n) => Number.isFinite(n) && n > 0);
        const nilai_taksiran_total = listNilai.reduce((a, b) => a + b, 0);
        const rata_rata = listNilai.length
          ? Math.round(nilai_taksiran_total / listNilai.length)
          : 0;
        const faktor = Number(currentKondisiFactor) || 0.6;
        const jenis =
          (inputLelang.jenis_kendaraan || "").trim() || "Roda 4 atau lebih";
        const limit_lelang = Math.round(rata_rata * faktor);
        const pembulatan = Math.round(limit_lelang / 1000) * 1000;

        const btn = $("#btnSimpanKertasKerja");
        btn.disabled = true;

        try {
          const payload = {
            input_lelang: {
              nama_objek: inputLelang.nama_objek,
              lokasi_objek: inputLelang.lokasi_objek,
              nup: inputLelang.nup,
              kategori_lokasi: inputLelang.kategori_lokasi,

              merek_kendaraan: inputLelang.merek_kendaraan,
              tipe_kendaraan: inputLelang.tipe_kendaraan,

              nomor_polisi: inputLelang.nomor_polisi,
              pemilik_dokumen: inputLelang.pemilik_dokumen,
              jenis_kendaraan: jenisStr, // hasil normalisasi
              kondisi_kendaraan: String(currentKondisiFactor.toFixed(1)), // "0.5"/"0.6"/"0.7"
              dokumen_kepemilikan: dokList,
              dokumen_lainnya: dokumenLainnya,

              faktor_kondisi: faktor, // tetap kirim kalau dipakai

              masa_berlaku: (inputLelang.masa_berlaku || "")
                .toLowerCase()
                .includes("habis")
                ? "Habis Masa Berlaku"
                : "Masih Berlaku",
              penggunaan_kendaraan: inputLelang.penggunaan_kendaraan,
              keterangan:
                inputLelang.keterangan || inputLelang.keterangan_lain || "",
              warna: inputLelang.warna,
              tahun_pembuatan: Number(inputLelang.tahun_pembuatan) || 0,
              bahan_bakar: inputLelang.bahan_bakar,
              provinsi: inputLelang.provinsi || "",
            },

            data_pembanding,
            data_penyesuaian,

            hasil_taksiran: {
              // total / jumlah dari setiap baris taksiran
              nilai_taksiran: nilai_taksiran_total, // alias baru
              total_nilai_taksiran: nilai_taksiran_total, // alias lama

              rata_rata_nilai_taksiran: rata_rata,
              taksiran_nilai_limit_lelang: limit_lelang,

              // pembulatan limit
              pembulatan_nilai_taksiran: pembulatan, // dipakai GET riwayat
              pembulatan: pembulatan, // alias lama (kalau PDF cari ini)
            },

            // Field root yang juga dibaca backend/PDF
            faktor_kondisi: faktor,
            jenis_kendaraan: jenis,
            nilai_taksiran_total,
          };

          const res = await fetch(`${API_BASE}/kertas-kerja/`, {
            method: "POST",
            headers: SATKER
              ? SATKER.headers({ "Content-Type": "application/json" })
              : { "Content-Type": "application/json" },
            body: JSON.stringify(payload),
          });

          const result =
            res.status !== 204 ? await res.json().catch(() => ({})) : {};
          if (res.ok) {
            modal.showSuccess(result.message || "Berhasil disimpan");
            sessionStorage.removeItem(draftKey);
            localStorage.setItem("kk_dirty", "1"); // beri tahu halaman riwayat untuk refresh
            setTimeout(() => {
              modal.close();
              window.location.replace("Riwayat.html");
            }, 900);
          } else {
            modal.close();
            alert(result.message || `Gagal menyimpan (HTTP ${res.status}).`);
          }
        } catch (e) {
          modal.close();
          alert("Gagal menyimpan (network/CORS): " + (e?.message || e));
          console.error("Create KK network error:", e);
        } finally {
          btn.disabled = false;
        }
      }

      /* ===================== INIT ===================== */
      (function init() {
        if (!tryRestoreFromDraft()) {
          renderPembanding();
          recalcAll();
        }
        window.addEventListener("storage", () => {
          const fresh = JSON.parse(
            sessionStorage.getItem("dataKertasKerja") || "{}"
          );
          if (fresh.kondisi_kendaraan) {
            currentKondisiFactor = getKondisiFactor(fresh.kondisi_kendaraan);
            recalcAll();
          }
        });
      })();
    </script>
  </body>
</html>
