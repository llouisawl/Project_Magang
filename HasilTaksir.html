<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Data Kendaraan dan Kondisi Fisik | e-Taksir</title>
    <link rel="stylesheet" href="HasilTaksir.css" />
  </head>
  <body>
    <div class="main-wrapper">
      <div class="top-bar">
        <button class="btn-back" onclick="window.history.back();">
          <svg width="32" height="32" viewBox="0 0 28 28">
            <path
              d="M18 22l-8-8 8-8"
              stroke="#666"
              stroke-width="2.5"
              fill="none"
              stroke-linecap="round"
              stroke-linejoin="round"
            />
          </svg>
        </button>
        <img
          src="Gambar/Kemenkeu.png"
          alt="Logo Kemenkeu"
          class="logo-kemenkeu"
        />
      </div>
      <div class="result-card">
        <h2 class="section-title">Data Kendaraan dan Kondisi Fisik</h2>
        <div class="vehicle-data-box">
          <img src="Gambar/Logo.png" class="logoe" alt="" />
          <div class="vehicle-group" id="vehicleGroup"></div>
        </div>
        <div class="table-title">
          <span>Data Hasil Lelang </span>
          <span class="brand-highlight" id="lelangBrand">-</span>
        </div>
        <div class="table-responsive">
          <table id="tabelHasilLelang">
            <thead>
              <tr>
                <th>No</th>
                <th>Kode Lelang</th>
                <th>Merek</th>
                <th>Tipe</th>
                <th>Harga Lelang</th>
                <th>Waktu Lelang</th>
                <th colspan="2" class="kategori-header">
                  Kategori Lokasi Lelang
                </th>
                <th>Tahun Pembuatan</th>
                <th class="aksi-header fade-table-col">Aksi</th>
              </tr>
            </thead>
            <tbody id="tbodyPembanding">
              <!-- Baris data otomatis/manual, diisi JS -->
            </tbody>
          </table>
        </div>
        <!-- TOMBOL TAMBAH DATA -->
        <div class="table-btn-row" id="rowTambahData">
          <button
            class="btn-tambah"
            id="btnTambahManual"
            onclick="tambahManual()"
            style="margin-top: 10px"
          >
            + Tambah Data
          </button>
        </div>
        <!-- TOMBOL EDIT DATA (AWALNYA HIDDEN) -->
        <div class="table-btn-row" id="rowEditData" style="display: none">
          <button
            class="btn-tambah"
            onclick="editKembaliData()"
            style="margin-top: 10px"
          >
            Edit Data
          </button>
        </div>
        <div
          class="info-status"
          id="infoPenyesuaian"
          style="color: #ff922b; margin: 10px 0 20px 0; text-align: center"
        >
          <b>
            Saat ini Nilai Taksiran belum dapat dihitung. Silahkan pastikan data
            pembanding yang ada minimal 3 data dan maksimal 7 data
          </b>
        </div>
        <div class="aksi-row" style="text-align: center">
          <button
            class="btn-simpan"
            id="btnHasilTaksir"
            disabled
            onclick="tampilkanPenyesuaian()"
          >
            Hasil Taksiran
          </button>
        </div>
        <div
          class="penyesuaian-section"
          id="penyesuaianSection"
          style="display: none"
        >
          <div class="table-title" style="margin-top: 28px">Penyesuaian</div>
          <div class="table-responsive">
            <table id="tabelPenyesuaian">
              <thead>
                <tr>
                  <th>No</th>
                  <th>Data Hasil Lelang</th>
                  <th>Tipe</th>
                  <th>Merk</th>
                  <th>Waktu</th>
                  <th>Lokasi</th>
                  <th>Tahun Pembuatan</th>
                  <th>Total</th>
                  <th>Nilai Taksiran</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td>1</td>
                  <td>Toyota</td>
                  <td>0%</td>
                  <td>0%</td>
                  <td>4%</td>
                  <td>0%</td>
                  <td>0%</td>
                  <td>0%</td>
                  <td>Rp 69 768 000</td>
                </tr>
              </tbody>
            </table>
          </div>
          <div class="nilai-row">
            <div class="nilai-box">
              <span class="nilai-label">RATA - RATA NILAI TAKSIRAN</span>
              <span class="nilai-val" id="rataTaksir">Rp 69 768 000</span>
            </div>
            <div class="nilai-box">
              <span class="nilai-label">TAKSIRAN NILAI LIMIT LELANG</span>
              <span class="nilai-val" id="limitTaksir">Rp 69 768 000</span>
            </div>
            <div class="nilai-box">
              <span class="nilai-label">PEMBULATAN</span>
              <span class="nilai-val" id="pembulatan">Rp 69 768 000</span>
            </div>
          </div>
          <div class="btn-simpan-row">
            <button class="btn-simpan" onclick="saveKertasKerjaToExcel()">
              Simpan
            </button>
          </div>
        </div>
      </div>
    </div>
    <script src="config.js"></script>
    <script>
      let inputLelang = null;
      let dataPembanding = [];
      let jwt = localStorage.getItem("jwt_token");

      // Ambil data kendaraan dari sessionStorage
      inputLelang = JSON.parse(
        sessionStorage.getItem("dataKertasKerja") || "{}"
      );

      function isi(val, fallback = "-") {
        if (Array.isArray(val))
          return val.length > 0 ? val.join(", ") : fallback;
        return val && val !== "" ? val : fallback;
      }

      document.getElementById("vehicleGroup").innerHTML = `
          <h2>IDENTIFIKASI</h2>
          <div class="row">
            <div class="field"><label>NAMA OBJEK</label><div class="val">${isi(
              inputLelang.nama_objek,
              "Daihatsu"
            )}</div></div>
            <div class="field"><label>NUP</label><div class="val">${isi(
              inputLelang.nup,
              "-"
            )}</div></div>
          </div>
          <div class="row">
            <div class="field"><label>LOKASI OBJEK</label><div class="val">${isi(
              inputLelang.lokasi_objek,
              "Cirebon"
            )}</div></div>
            <div class="field"><label>KATEGORI LOKASI</label><div class="val">${isi(
              inputLelang.kategori_lokasi,
              "1"
            )}</div></div>
          </div>
          <div class="row">
            <div class="field"><label>JENIS KENDARAAN</label><div class="val">${isi(
              inputLelang.jenis_kendaraan,
              "Roda 4 atau lebih"
            )}</div></div>
            <div class="field"><label>MERK KENDARAAN</label><div class="val">${isi(
              inputLelang.merek_kendaraan,
              "Daihatsu"
            )}</div></div>
            <div class="field"><label>TIPE KENDARAAN</label><div class="val">${isi(
              inputLelang.tipe_kendaraan,
              "Sigra 1.2 MT"
            )}</div></div>
          </div>
          <div class="sub-group">
            <div class="sub-label">Identitas Kendaraan</div>
            <div class="row">
              <div class="field"><label>NOMOR POLISI</label><div class="val">${isi(
                inputLelang.nomor_polisi,
                "DB 1234 GU"
              )}</div></div>
              <div class="field"><label>DOKUMEN KEPEMILIKAN</label><div class="val">${isi(
                inputLelang.dokumen_kepemilikan,
                "Tidak Ada"
              )}</div></div>
            </div>
          </div>
          <div class="row">
            <div class="field"><label>PEMILIK DOKUMEN</label><div class="val">${isi(
              inputLelang.pemilik_dokumen,
              "Kementrian X"
            )}</div></div>
            <div class="field"><label>MASA BERLAKU</label><div class="val">${isi(
              inputLelang.masa_berlaku,
              "Masih Berlaku"
            )}</div></div>
          </div>
          <div class="sub-group">
            <div class="sub-label">Keterangan</div>
            <div class="row">
              <div class="field"><label>PENGGUNAAN KENDARAAN</label><div class="val">${isi(
                inputLelang.penggunaan_kendaraan
              )}</div></div>
              <div class="field"><label>KETERANGAN LAINNYA</label><div class="val">${isi(
                inputLelang.keterangan_lain,
                "-"
              )}</div></div>
            </div>
          </div>
          <h2>FISIK KENDARAAN</h2>
          <div class="row">
            <div class="field"><label>WARNA</label><div class="val">${isi(
              inputLelang.warna,
              "Hitam"
            )}</div></div>
            <div class="field"><label>TAHUN PEMBUATAN</label><div class="val">${isi(
              inputLelang.tahun_pembuatan,
              "2019"
            )}</div></div>
            <div class="field"><label>BAHAN BAKAR</label><div class="val">${isi(
              inputLelang.bahan_bakar,
              "Bensin"
            )}</div></div>
          </div>
          <div class="row">
            <div class="field" style="flex:2;"><label>KONDISI KENDARAAN</label><div class="val">${isi(
              inputLelang.kondisi_kendaraan,
              "0,5 (Tingkat kerusakan diatas 90%)"
            )}</div></div>
          </div>
        `;
      document.getElementById("lelangBrand").textContent = isi(
        inputLelang.merek_kendaraan
      );
      // Ambil data pembanding dari API (POST)
      function getDataPembanding() {
        fetch(`${API_URL}/kertas-kerja/`, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            Authorization: `Bearer ${jwt}`,
          },
          body: JSON.stringify({
            merek_kendaraan: inputLelang.merek_kendaraan,
            tipe_kendaraan: inputLelang.tipe_kendaraan,
            tahun_pembuatan: parseInt(inputLelang.tahun_pembuatan), // tahun_pembuatan harus number
            lokasi_objek: inputLelang.lokasi_objek,
          }),
        })
          .then((res) => res.json())
          .then((res) => {
            console.log(res.data);

            if (
              res.status_code === "200" &&
              res.data &&
              Array.isArray(res.data.data_pembanding)
            ) {
              dataPembanding = res.data.data_pembanding;
              // Simpan list kode & data by kode untuk tambah manual
              kodeLelangList = dataPembanding.map((x) => x.KodeLelang);
              dataLelangByKode = {};
              dataPembanding.forEach((x) => {
                dataLelangByKode[x.KodeLelang] = x;
              });
              tampilkanDataPembanding();
              updateStatePembanding();
            } else {
              alert(
                res.message || "Gagal mengambil data pembanding (Frontend)."
              );
            }
          })
          .catch((err) => {
            alert("Koneksi gagal ke endpoint pembanding");
            console.error(err);
          });
      }
      getDataPembanding();

      // ===== NOMOR URUT =====
      function updateTableNumbers() {
        const rows = document.querySelectorAll("#tbodyPembanding tr");
        rows.forEach((tr, idx) => {
          let noCell = tr.querySelector("td:first-child");
          if (noCell) noCell.textContent = idx + 1;
        });
      }

      // ===== TAMBAH BARIS =====
      function tambahManual() {
        const tbody = document.getElementById("tbodyPembanding");
        if (tbody.rows.length >= 7) return;

        let kodeOptions = `<option value="">Pilih Kode</option>`;
        kodeLelangList.forEach((k) => {
          kodeOptions += `<option value="${k}">${k}</option>`;
        });

        const tr = document.createElement("tr");
        tr.innerHTML = `
            <td></td>
            <td>
              <select onchange="isiOtomatisDataLelang(this)">
                ${kodeOptions}
              </select>
            </td>
            <td class="merek"></td>
            <td class="tipe"></td>
            <td class="harga"></td>
            <td class="waktu"></td>
            <td class="lokasi"></td>
            <td class="kategori"></td>
            <td class="tahun"></td>
            <td class="fade-table-col aksi-cell">
              <button class="btn-hapus" onclick="hapusBaris(this)">
                Hapus
              </button>
            </td>
          `;

        tr.classList.add("fade-in-row");
        tbody.appendChild(tr);
        setTimeout(() => {
          tr.classList.remove("fade-in-row");
        }, 320);

        updateTableNumbers();
        updateStatePembanding();
      }

      // ===== ISI OTOMATIS (ambil dari objek dataLelangByKode sesuai struktur baru) =====
      function isiOtomatisDataLelang(select) {
        const kode = select.value;
        const tr = select.closest("tr");
        if (!kodeLelangList.includes(kode) || !dataLelangByKode[kode]) {
          [
            "merek",
            "tipe",
            "harga",
            "waktu",
            "lokasi",
            "kategori",
            "tahun",
          ].forEach((c) => {
            tr.querySelector(`.${c}`).textContent = "";
          });
          return;
        }
        const d = dataLelangByKode[kode];
        tr.querySelector(".merek").textContent = d.Merek || "-";
        tr.querySelector(".tipe").textContent = d.Tipe || "-";
        tr.querySelector(".harga").textContent = d.HargaLelang
          ? "Rp " + Number(d.HargaLelang).toLocaleString("id-ID")
          : "-";
        tr.querySelector(".waktu").textContent = d.TahunTransaksi || "-";
        tr.querySelector(".lokasi").textContent = d.Lokasi || "-";
        tr.querySelector(".kategori").textContent = d.KategoriLokasi || "-";
        tr.querySelector(".tahun").textContent = d.TahunPembuatan || "-";
      }

      // ===== HAPUS BARIS =====
      function hapusBaris(btn) {
        const row = btn.closest("tr");
        row.classList.add("fading-out");
        setTimeout(() => {
          row.remove();
          updateTableNumbers();
          updateStatePembanding();
        }, 340);
      }

      // ===== STATE BUTTON & INFO =====
      function updateStatePembanding() {
        const tbody = document.getElementById("tbodyPembanding");
        const btn = document.getElementById("btnHasilTaksir");
        const info = document.getElementById("infoPenyesuaian");
        let rowCount = tbody.rows.length;
        btn.disabled = !(rowCount >= 3 && rowCount <= 7);
        info.style.display = rowCount >= 3 && rowCount <= 7 ? "none" : "block";
      }

      // ===== TAMPILKAN PENYESUAIAN (FADE) =====
      function tampilkanPenyesuaian() {
        document.getElementById("penyesuaianSection").style.display = "block";
        document.getElementById("btnHasilTaksir").style.display = "none";
        document.getElementById("rowTambahData").style.display = "none";
        document.getElementById("rowEditData").style.display = "flex";

        // Fade out kolom aksi pada header
        let aksiHeader = document.querySelector("th.aksi-header");
        if (aksiHeader) {
          aksiHeader.style.transition = "opacity 0.32s";
          aksiHeader.style.opacity = "0";
          setTimeout(() => {
            aksiHeader.parentNode.removeChild(aksiHeader);
            updateTableNumbers();
          }, 320);
        }

        // Fade out semua td aksi di baris
        document.querySelectorAll("#tbodyPembanding tr").forEach((tr) => {
          let aksiCell = tr.querySelector("td.aksi-cell");
          if (aksiCell) {
            aksiCell.style.transition = "opacity 0.32s";
            aksiCell.style.opacity = "0";
            setTimeout(() => {
              aksiCell.parentNode.removeChild(aksiCell);
              updateTableNumbers();
            }, 320);
          }
        });
      }

      // ===== EDIT KEMBALI (FADE IN) =====
      function editKembaliData() {
        document.getElementById("penyesuaianSection").style.display = "none";
        document.getElementById("btnHasilTaksir").style.display = "";
        document.getElementById("rowTambahData").style.display = "flex";
        document.getElementById("rowEditData").style.display = "none";

        // Header aksi
        let theadRow = document.querySelector("#tabelHasilLelang thead tr");
        if (theadRow && !theadRow.querySelector(".aksi-header")) {
          let th = document.createElement("th");
          th.className = "aksi-header";
          th.textContent = "Aksi";
          th.style.opacity = "0";
          theadRow.appendChild(th);
          setTimeout(() => {
            th.style.transition = "opacity 0.32s";
            th.style.opacity = "1";
          }, 10);
        }
        // Semua baris, tambah td aksi jika belum ada
        document.querySelectorAll("#tbodyPembanding tr").forEach((tr) => {
          if (!tr.querySelector("td.aksi-cell")) {
            let td = document.createElement("td");
            td.className = "aksi-cell";
            td.innerHTML = `<button class="btn-hapus" onclick="hapusBaris(this)">Hapus</button>`;
            td.style.opacity = "0";
            tr.appendChild(td);
            setTimeout(() => {
              td.style.transition = "opacity 0.32s";
              td.style.opacity = "1";
            }, 10);
          }
        });
        updateTableNumbers();
      }

      function tampilkanDataPembanding() {
        const tbody = document.getElementById("tbodyPembanding");
        tbody.innerHTML = ""; // Kosongkan dulu

        // Jika tidak ada data pembanding, tampilkan baris kosong
        if (!dataPembanding || dataPembanding.length === 0) {
          const tr = document.createElement("tr");
          tr.innerHTML = `<td colspan="10" style="text-align:center;">Belum ada data pembanding.</td>`;
          tbody.appendChild(tr);
          updateStatePembanding();
          return;
        }

        // Untuk option tambah manual & mapping
        kodeLelangList.length = 0;
        dataLelangByKode = {};

        dataPembanding.forEach((d, i) => {
          // Update kode & mapping untuk option di tambahManual()
          kodeLelangList.push(d.KodeLelang);
          dataLelangByKode[d.KodeLelang] = d;

          const tr = document.createElement("tr");
          tr.innerHTML = `
        <td>${i + 1}</td>
        <td>
          <select onchange="isiOtomatisDataLelang(this)">
            <option value="${d.KodeLelang}">${d.KodeLelang}</option>
          </select>
        </td>
        <td class="merek">${d.Merek || "-"}</td>
        <td class="tipe">${d.Tipe || "-"}</td>
        <td class="harga">${
          d.HargaLelang
            ? "Rp " + Number(d.HargaLelang).toLocaleString("id-ID")
            : "-"
        }</td>
        <td class="waktu">${d.TahunTransaksi || "-"}</td>
        <td class="lokasi">${d.Lokasi || "-"}</td>
        <td class="kategori">${d.KategoriLokasi || "-"}</td>
        <td class="tahun">${d.TahunPembuatan || "-"}</td>
        <td class="fade-table-col aksi-cell">
          <button class="btn-hapus" onclick="hapusBaris(this)">Hapus</button>
        </td>
      `;
          tbody.appendChild(tr);
        });

        updateStatePembanding();
      }

      function saveKertasKerjaToExcel() {
        // Validasi data
        if (!inputLelang || !dataPembanding || dataPembanding.length < 3) {
          alert("Data pembanding minimal 3 baris dan data input lengkap!");
          return;
        }

        const inputPayload = {
          input_lelang: {
            bahan_bakar: inputLelang.bahan_bakar || "",
            dokumen_kepemilikan: inputLelang.dokumen_kepemilikan || "",
            jenis_kendaraan: inputLelang.jenis_kendaraan || "",
            kategori_lokasi: inputLelang.kategori_lokasi || "",
            keterangan:
              inputLelang.keterangan_lain || inputLelang.keterangan || "",
            kondisi_kendaraan: inputLelang.kondisi_kendaraan || "",
            lokasi_objek: inputLelang.lokasi_objek || "",
            masa_berlaku: inputLelang.masa_berlaku || "",
            merek_kendaraan: inputLelang.merek_kendaraan || "",
            nama_objek: inputLelang.nama_objek || "",
            nomor_polisi: inputLelang.nomor_polisi || "",
            nup: inputLelang.nup || "",
            pemilik_dokumen: inputLelang.pemilik_dokumen || "",
            penggunaan_kendaraan: inputLelang.penggunaan_kendaraan || "",
            provinsi: inputLelang.provinsi || "",
            tahun_pembuatan: Number(inputLelang.tahun_pembuatan) || 0,
            tipe_kendaraan: inputLelang.tipe_kendaraan || "",
            warna: inputLelang.warna || "",
          },
          data_pembanding: dataPembanding,
        };

        const btn = document.getElementById("btnSimpanKertasKerja");
        if (btn) btn.disabled = true;

        fetch(`${API_URL}/kertas-kerja/save`, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            Authorization: `Bearer ${jwt}`,
          },
          body: JSON.stringify({
            input_lelang: {
              nama_objek: inputLelang.nama_objek,
              lokasi_objek: inputLelang.lokasi_objek,
              nup: inputLelang.nup,
              kategori_lokasi: inputLelang.kategori_lokasi,
              merek_kendaraan: inputLelang.merek_kendaraan,
              tipe_kendaraan: inputLelang.tipe_kendaraan,
              nomor_polisi: inputLelang.nomor_polisi,
              dokumen_kepemilikan: inputLelang.dokumen_kepemilikan,
              pemilik_dokumen: inputLelang.pemilik_dokumen,
              jenis_kendaraan: inputLelang.jenis_kendaraan,
              masa_berlaku: inputLelang.masa_berlaku,
              penggunaan_kendaraan: inputLelang.penggunaan_kendaraan,
              keterangan: inputLelang.keterangan || "", // fallback kalau kosong
              warna: inputLelang.warna,
              tahun_pembuatan: Number(inputLelang.tahun_pembuatan) || 0,
              bahan_bakar: inputLelang.bahan_bakar,
              kondisi_kendaraan: inputLelang.kondisi_kendaraan,
              provinsi: inputLelang.provinsi || "",
            },
            data_pembanding: dataPembanding.map((item) => ({
              KodeLelang: item.KodeLelang,
              Merek: item.Merek,
              Tipe: item.Tipe,
              TahunPembuatan: item.TahunPembuatan,
              TahunTransaksi: item.TahunTransaksi,
              Lokasi: item.Lokasi,
              KategoriLokasi: item.KategoriLokasi,
              HargaLelang: item.HargaLelang,
            })),
          }),
        })
          .then(async (res) => {
            let result;
            try {
              result = await res.json();
            } catch {
              result = { message: "Gagal parse response server" };
            }
            if (res.ok && result && result.message) {
              alert(result.message); // Tampilkan pesan dari backend, misal "Berhasil"
            } else {
              alert(result.message || "Gagal menyimpan data!");
            }
          })
          .catch((err) => {
            alert("Terjadi error: " + err);
          })
          .finally(() => {
            if (btn) btn.disabled = false;
          });
      }
    </script>
  </body>
</html>
