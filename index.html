<!doctype html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>SirOTO | Satker</title>
    <link rel="stylesheet" href="index.css" />

    <!-- Konfigurasi & Auth -->
    <script src="config.js"></script>
    <script src="auth.js"></script>
    <!-- Select2 CSS -->
    <link
      href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css"
      rel="stylesheet"
    />

    <!-- jQuery (WAJIB untuk Select2) -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

    <!-- Select2 JS -->
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

    <!-- Kunci halaman khusus SATKER -->
    <script>
      (function () {
        try {
          Auth.protectPage("satker");
        } catch (e) {}
      })();
    </script>
  </head>

  <body>
    <div class="container">
      <!-- Sidebar -->
      <aside class="sidebar">
        <div class="sidebar-header-flex">
          <img src="Gambar/D4.png" alt="Logo Kemenkeu" class="logo-kemenkeu" />
          <div class="profile-dropdown">
            <span class="profile-icon" tabindex="0">
              <svg width="38" height="38" viewBox="0 0 38 38" fill="none">
                <circle cx="19" cy="19" r="19" fill="#eef7e6" />
                <path
                  d="M19 19c3.31 0 6-2.69 6-6s-2.69-6-6-6-6 2.69-6 6 2.69 6 6 6zM19 21c-4.41 0-8 2.24-8 5v2h16v-2c0-2.76-3.59-5-8-5z"
                  fill="#6fb32b"
                />
              </svg>
            </span>
            <div class="dropdown-content">
              <a href="daftar.html" class="logout-link" id="satkerLogout">
                <svg
                  width="17"
                  height="17"
                  fill="none"
                  viewBox="0 0 24 24"
                  stroke="#e04848"
                  style="vertical-align: middle; margin-right: 7px"
                >
                  <path
                    stroke-width="2"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a2 2 0 0 1-2 2h-3a2 2 0 0 1-2-2V7a2 2 0 0 1 2-2h3a2 2 0 0 1 2 2v1"
                  />
                </svg>
                Logout
              </a>
            </div>
          </div>
        </div>

        <div class="welcome-row">
          <img src="Gambar/siroto2.png" alt="Icon" class="welcome-icon" />
          <div class="welcome-text">
            <span>Selamat Datang</span>
            <h3 id="welcomeName">Pengguna</h3>
          </div>
        </div>

        <nav>
          <ul>
            <li class="nav-item active">
              <a href="Riwayat.html" class="nav-link">
                <span class="nav-icon">
                  <svg
                    width="20"
                    height="20"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="#22c55e"
                    stroke-width="2"
                  >
                    <path d="M3 3v5h5"></path>
                    <path d="M3.05 13A9 9 0 1 0 6 5.3L3 8"></path>
                    <polyline points="12 7 12 12 15 15"></polyline>
                  </svg>
                </span>
                <span class="nav-text">Riwayat Kertas Kerja</span>
              </a>
            </li>
          </ul>
        </nav>
      </aside>

      <!-- Main Content -->
      <main>
        <h1>Kertas Kerja Penentuan Nilai Taksiran BMN (Lelang Kendaraan)</h1>
        <form id="kertasKerjaForm">
          <section>
            <h2>IDENTIFIKASI</h2>
            <div class="row">
              <div class="input-group">
                <label>Nama Objek</label>
                <input type="text" name="nama_objek" required />
              </div>
              <div class="input-group">
                <label>NUP</label>
                <input type="text" name="nup" required />
              </div>
            </div>

            <div class="row">
              <div class="input-group">
                <label>Lokasi Objek</label>
                <select name="lokasi_objek" id="lokasi_objek" required></select>
              </div>

              <div class="input-group">
                <label>Kategori Lokasi</label>
                <input
                  type="text"
                  id="kategori_lokasi"
                  name="kategori_lokasi"
                  class="locked-input"
                  readonly
                  placeholder="Otomatis dari lokasi"
                  required
                />
              </div>

              <div class="input-group">
                <label>Provinsi</label>
                <input
                  type="text"
                  id="provinsi"
                  name="provinsi"
                  readonly
                  class="locked-input"
                  placeholder="Otomatis dari lokasi"
                  required
                />
              </div>
              <input type="hidden" id="kpknl" name="kpknl" />
            </div>

            <div class="row">
              <div class="input-group">
                <label>Jenis Kendaraan</label>
                <select
                  name="jenis_kendaraan"
                  id="jenis_kendaraan"
                  required
                  onchange="updateMerek()"
                >
                  <option value="">Pilih</option>
                  <option value="Roda 2 atau 3">Roda 2 atau 3</option>
                  <option value="Roda 4 atau lebih">Roda 4 atau lebih</option>
                </select>
              </div>
              <div class="input-group" id="cc_roda2" style="display: none">
                <label>CC Kendaraan</label>
                <select name="cc_kendaraan_roda2" id="cc_kendaraan_roda2">
                  <option value="">Pilih CC</option>
                  <option value="low">â‰¤ 100 cc</option>
                  <option value="middle">100 â€“ 150 cc</option>
                  <option value="high">&gt; 150 cc</option>
                </select>
              </div>
              <div class="input-group" id="cc_roda4" style="display: none">
                <label>CC Kendaraan</label>
                <select name="cc_kendaraan_roda4" id="cc_kendaraan_roda4">
                  <option value="">Pilih CC</option>
                  <option value="low">â‰¤ 1200 cc</option>
                  <option value="middle">1200 â€“ 2500 cc</option>
                  <option value="high">&gt; 2500 cc</option>
                </select>
              </div>
            </div>

            <div class="row">
              <div class="input-group">
                <label>Merek Kendaraan</label>
                <select
                  name="merek_kendaraan"
                  id="merek_kendaraan"
                  required
                  onchange="updateTipe()"
                >
                  <option value="">Pilih Merek</option>
                </select>
              </div>
              <div class="input-group">
                <label>Tipe Kendaraan</label>
                <select
                  id="tipe_kendaraan"
                  name="tipe_kendaraan"
                  required
                  disabled
                >
                  <option value="">Pilih Tipe</option>
                </select>
              </div>
              <div class="input-group">
                <label>Nomor Polisi</label>
                <input type="text" name="nomor_polisi" required />
              </div>
            </div>

            <div class="row">
              <div class="input-group">
                <label>Dokumen Kepemilikan</label>
                <div class="checkbox-group">
                  <label
                    ><input
                      type="checkbox"
                      name="dokumen_kepemilikan[]"
                      value="BPKB"
                    />
                    BPKB</label
                  >
                  <label
                    ><input
                      type="checkbox"
                      name="dokumen_kepemilikan[]"
                      value="STNK"
                    />
                    STNK</label
                  >
                  <label>
                    <input
                      type="checkbox"
                      id="lainnyaCheckbox"
                      onchange="toggleLainnyaInput(this)"
                    />
                    Lainnya
                    <input
                      type="text"
                      name="dokumen_kepemilikan[]"
                      id="lainnyaInput"
                      placeholder="Tulis dokumen lain..."
                      style="display: none; margin-left: 8px; width: 140px"
                    />
                  </label>
                  <label>
                    <input
                      type="checkbox"
                      id="tidakAdaCheckbox"
                      value="Tidak Ada"
                    />
                    Tidak Ada
                  </label>
                </div>
              </div>
              <div class="input-group">
                <label>Pemilik Dokumen</label>
                <input
                  type="text"
                  id="pemilik_dokumen"
                  name="pemilik_dokumen"
                  readonly
                  class="locked-input"
                />
              </div>
            </div>

            <div class="row">
              <div class="input-group">
                <label>Masa Berlaku</label>
                <select name="masa_berlaku" required>
                  <option value="">Pilih</option>
                  <option value="Masih Berlaku">Masih Berlaku</option>
                  <option value="Habis Masih Berlaku">
                    Habis Masih Berlaku
                  </option>
                </select>
              </div>
              <div class="input-group">
                <div class="input-group">
                  <label>Penggunaan Kendaraan</label>
                  <input
                    type="text"
                    id="penggunaan_kendaraan"
                    name="penggunaan_kendaraan"
                    readonly
                    class="locked-input"
                    value="Kendaraan Dinas"
                  />
                </div>
              </div>
            </div>

            <div class="row">
              <div class="input-group">
                <label>Keterangan Lain</label>
                <input type="text" name="keterangan_lain" />
              </div>
            </div>
          </section>

          <section>
            <h2>FISIK KENDARAAN</h2>
            <div class="row">
              <div class="input-group">
                <label>Warna</label>
                <select name="warna" id="warna" required>
                  <option value="">Pilih Warna Kendaraan</option>
                </select>
              </div>
              <div class="input-group">
                <label>Tahun Pembuatan</label>
                <input
                  type="number"
                  name="tahun_pembuatan"
                  id="tahun_pembuatan"
                  placeholder="Contoh: 2018"
                  min="1900"
                  max="2099"
                  required
                />
              </div>
              <div class="input-group">
                <label>Bahan Bakar</label>
                <select name="bahan_bakar" required>
                  <option value="">Pilih</option>
                  <option value="Bensin">Bensin</option>
                  <option value="Solar">Solar</option>
                </select>
              </div>
              <div class="input-group">
                <label>Kondisi Kendaraan</label>
                <select name="kondisi_kendaraan" required>
                  <option value="">Pilih</option>
                  <option value="0.5 (Tingkat kerusakan diatas 90%)">
                    0.5 (Tingkat kerusakan diatas 90%)
                  </option>
                  <option value="0.6 (Tingkat kerusakan diatas 80%-90%)">
                    0.6 (Tingkat kerusakan diatas 80%-90%)
                  </option>
                  <option value="0.7 (Tingkat kerusakan sampai dengan 80%)">
                    0.7 (Tingkat kerusakan sampai dengan 80%)
                  </option>
                </select>
              </div>
            </div>
          </section>

          <div class="actions">
            <button type="button" class="btn-clear" onclick="openClearModal()">
              Clear Data
            </button>

            <button type="submit" class="submit-btn">Data Pembanding</button>
          </div>
        </form>
      </main>
    </div>

    <!-- ====== SCRIPT LOGIKA FORM ====== -->
    <script>
      // Tampilkan CC dinamis
      function tampilkanCC() {
        var jenis = document.getElementById("jenis_kendaraan").value;
        var ccRoda2 = document.getElementById("cc_roda2");
        var ccRoda4 = document.getElementById("cc_roda4");
        ccRoda2.style.display = "none";
        ccRoda4.style.display = "none";
        document.getElementById("cc_kendaraan_roda2").required = false;
        document.getElementById("cc_kendaraan_roda4").required = false;
        if (jenis === "Roda 2 atau 3") {
          ccRoda2.style.display = "block";
          document.getElementById("cc_kendaraan_roda2").required = true;
        } else if (jenis === "Roda 4 atau lebih") {
          ccRoda4.style.display = "block";
          document.getElementById("cc_kendaraan_roda4").required = true;
        }
      }
      // Ambil angka faktor_kondisi dari dropdown (0.5/0.6/0.7)
      function extractFaktorKondisi(selectEl) {
        if (!selectEl) return 0.6;
        const raw = (
          selectEl.value ||
          selectEl.options[selectEl.selectedIndex]?.text ||
          ""
        ).trim();
        const m = raw.replace(",", ".").match(/[0-9.]+/);
        const f = m ? parseFloat(m[0]) : NaN;
        return Number.isFinite(f) ? f : 0.6;
      }
      // Toggle input "Lainnya"
      function toggleLainnyaInput(checkbox) {
        var input = document.getElementById("lainnyaInput");
        input.style.display = checkbox.checked ? "inline-block" : "none";
        if (!checkbox.checked) input.value = "";
      }
    </script>

    <script>
      // Sinkronisasi checkboxes dokumen kepemilikan
      document.addEventListener("DOMContentLoaded", () => {
        const chkBpkb = document.querySelector(
          'input[name="dokumen_kepemilikan[]"][value="BPKB"]',
        );
        const chkStnk = document.querySelector(
          'input[name="dokumen_kepemilikan[]"][value="STNK"]',
        );
        const chkLain = document.getElementById("lainnyaCheckbox");
        const txtLain = document.getElementById("lainnyaInput");
        const chkTidak = document.getElementById("tidakAdaCheckbox");
        const nonTidak = [chkBpkb, chkStnk, chkLain];

        function applyTidakAdaState() {
          const on = chkTidak.checked;
          nonTidak.forEach((el) => {
            el.disabled = on;
            if (on) el.checked = false;
          });
          if (on) {
            txtLain.style.display = "none";
            txtLain.value = "";
          }
        }
        chkTidak.addEventListener("change", applyTidakAdaState);

        function deselectTidakAdaWhenOthers() {
          if (chkBpkb.checked || chkStnk.checked || chkLain.checked) {
            chkTidak.checked = false;
            applyTidakAdaState();
          }
        }
        chkBpkb.addEventListener("change", deselectTidakAdaWhenOthers);
        chkStnk.addEventListener("change", deselectTidakAdaWhenOthers);
        chkLain.addEventListener("change", () => {
          toggleLainnyaInput(chkLain);
          deselectTidakAdaWhenOthers();
        });
        txtLain.addEventListener("input", () => {
          if (txtLain.value.trim() !== "") {
            chkLain.checked = true;
            chkTidak.checked = false;
            applyTidakAdaState();
            txtLain.style.display = "inline-block";
          }
        });
      });
    </script>

    <script>
      // Submit form â†’ simpan ke sessionStorage â†’ pindah halaman
      document.addEventListener("DOMContentLoaded", () => {
        document
          .getElementById("kertasKerjaForm")
          .addEventListener("submit", function (e) {
            e.preventDefault();

            const fd = new FormData(this);
            const formData = {};

            // salin semua field normal (kecuali dokumen_kepemilikan[])
            for (let [k, v] of fd.entries()) {
              if (!k.startsWith("dokumen_kepemilikan"))
                formData[k] = (v ?? "").toString().trim();
            }

            // Dokumen kepemilikan + Tidak Ada
            const dokumen = [];
            const bpkb = this.querySelector(
              'input[name="dokumen_kepemilikan[]"][value="BPKB"]',
            )?.checked;
            const stnk = this.querySelector(
              'input[name="dokumen_kepemilikan[]"][value="STNK"]',
            )?.checked;
            const chkLain = this.querySelector("#lainnyaCheckbox")?.checked;
            const txtLain = (
              this.querySelector("#lainnyaInput")?.value || ""
            ).trim();
            const chkTidak = this.querySelector("#tidakAdaCheckbox")?.checked;

            if (bpkb) dokumen.push("BPKB");
            if (stnk) dokumen.push("STNK");
            if (chkLain) dokumen.push("Lainnya");

            if (chkTidak) {
              formData.dokumen_kepemilikan = [];
              formData.dokumen_kepemilikan_tidak_ada = true;
              formData.dok_lainnya_detail = "";
            } else {
              formData.dokumen_kepemilikan = dokumen;
              formData.dok_lainnya_detail = chkLain ? txtLain : "";
            }

            // Faktor kondisi
            const rawKondisi = fd.get("kondisi_kendaraan") || "";
            const faktor = (() => {
              const m = String(rawKondisi)
                .replace(",", ".")
                .match(/[0-9.]+/);
              const f = m ? parseFloat(m[0]) : NaN;
              return Number.isFinite(f) ? f : 0.6;
            })();
            formData.kondisi_kendaraan = rawKondisi;
            formData.faktor_kondisi = faktor;
            formData.kpknl = fd.get("kpknl"); // ðŸ”¥ TAMBAHAN

            // Hapus flow lama & draft lama
            sessionStorage.removeItem("kk_flow_id");

            // Hapus semua draft sebelumnya
            Object.keys(sessionStorage).forEach((key) => {
              if (key.startsWith("kk_draft_")) {
                sessionStorage.removeItem(key);
              }
            });

            // Simpan data terbaru
            sessionStorage.setItem("dataKertasKerja", JSON.stringify(formData));

            // Redirect
            window.location.href = "HasilTaksir.html";
          });
      });
    </script>

    <script>
      let dataKendaraan = [];

      fetch("JenisKendaraan.json")
        .then((res) => res.json())
        .then((data) => {
          dataKendaraan = data;
          console.log("Data kendaraan:", dataKendaraan.length);
        })
        .catch((err) => console.error("Gagal load JSON", err));
    </script>

    <script>
      function getKategoriObjek() {
        const jenis = document.getElementById("jenis_kendaraan").value;
        if (jenis === "Roda 2 atau 3") return "motor";
        if (jenis === "Roda 4 atau lebih") return "mobil";
        return null;
      }

      function updateMerek() {
        const kategori = getKategoriObjek();
        const selectMerek = $("#merek_kendaraan");
        const selectTipe = $("#tipe_kendaraan");

        selectMerek.empty().append('<option value="">Pilih Merek</option>');
        selectTipe
          .empty()
          .append('<option value="">Pilih Tipe</option>')
          .prop("disabled", true);

        if (!kategori) return;

        const merekUnik = [
          ...new Set(
            dataKendaraan
              .filter(
                (d) => d["KATEGORI OBJEK"].trim().toLowerCase() === kategori,
              )
              .map((d) => d["MEREK"].trim()),
          ),
        ];

        merekUnik.sort().forEach((merek) => {
          selectMerek.append(new Option(merek, merek));
        });

        selectMerek.trigger("change.select2");
      }

      function updateTipe() {
        const kategori = getKategoriObjek();
        const merek = $("#merek_kendaraan").val();
        const selectTipe = $("#tipe_kendaraan");

        selectTipe
          .empty()
          .append('<option value="">Pilih Tipe</option>')
          .prop("disabled", true);

        if (!kategori || !merek) return;

        const tipeUnik = [
          ...new Set(
            dataKendaraan
              .filter(
                (d) =>
                  d["KATEGORI OBJEK"].trim().toLowerCase() === kategori &&
                  d["MEREK"].trim().toLowerCase() === merek.toLowerCase(),
              )
              .map((d) => d["TIPE"].trim()),
          ),
        ];

        tipeUnik.sort().forEach((tipe) => {
          selectTipe.append(new Option(tipe, tipe));
        });

        selectTipe.prop("disabled", false).trigger("change.select2");
      }
    </script>

    <script>
      $(document).ready(function () {
        $("#merek_kendaraan").select2({
          placeholder: "Pilih Merek",
          allowClear: true,
          width: "resolve",
        });

        $("#tipe_kendaraan").select2({
          placeholder: "Pilih Tipe",
          allowClear: true,
          width: "resolve",
        });
      });
    </script>

    <script>
      // Array warna kendaraan, langsung dari list yang kamu berikan
      const daftarWarna = [
        "Abu - abu Metalik",
        "Abu - abu Titanium",
        "Abu abu Metalik",
        "Biru",
        "Biru Metalik",
        "Biru Tua Metalik",
        "Cokelat Muda",
        "Coklat Muda Hijau",
        "Hijau",
        "Hijau Hitam",
        "Hijau Metalik",
        "Hitam",
        "Hitam Biru",
        "Hitam Metalik",
        "Hitam Silver",
        "Merah Hitam",
        "Putih Biru",
        "Putih Kuning",
        "Putih Merah",
        "Silver",
        "Silver Metalik",
        "Stone Grey",
        "Abu - abu",
        "Abu - abu Baja",
        "Abu - abu Baja Metalik",
        "Abu - abu Biru",
        "Abu - abu bulan Metalik",
        "Abu - abu Cokelat",
        "Abu - abu Cokelat Metalik",
        "Abu - abu Cokelat Muda",
        "Abu - abu Coklat",
        "Abu - abu Coklat Muda",
        "Abu - abu Hitam",
        "Abu - abu Merah",
        "Abu - abu Metalik",
        "Abu - abu Metalik Hitam",
        "Abu - abu Mika",
        "Abu - abu Muda Biru Tua",
        "Abu - abu Muda Metalik",
        "Abu - abu Perak",
        "Abu - abu Perak Metalik",
        "Abu - abu Silver",
        "Abu - abu titanium",
        "Abu - abu TNI",
        "Abu - abu Tua",
        "Abu - abu Tua Metalik",
        "Abu - abu Tua Mika",
        "Abu - abu Tua/Silver Metalik",
        "Abu abu Metalik",
        "Abu-Abu",
        "Abu-Abu Hitam",
        "Abu-Abu Metalik",
        "Abu-abu tua metalik",
        "Admiral Blue",
        "Arganik Green",
        "Arktic White",
        "Army (Hijau abu - abu)",
        "Army Green",
        "Aurora Black",
        "Beige",
        "Biru",
        "Biru (eks abu-abu)",
        "Biru (Eks. Hitam)",
        "Biru Abu - abu",
        "Biru Abu Abu",
        "Biru Cream",
        "Biru Doff",
        "Biru Dongker",
        "Biru Hitam",
        "Biru Hitam Metalik",
        "Biru Kombinasi",
        "Biru Krem",
        "Biru Kuning",
        "Biru Langit",
        "Biru List Hitam",
        "Biru Malam",
        "Biru Mekanik",
        "Biru Merah",
        "Biru Metalik",
        "Biru Metalik Pudar",
        "Biru Muda",
        "Biru Muda Coklat Mud",
        "Biru Muda Metalik",
        "Biru Orange",
        "Biru Perak",
        "Biru Putih",
        "Biru Safir",
        "Biru Safir Metalik",
        "Biru Safir Mgt",
        "Biru Silver",
        "Biru Silver Metalik",
        "Biru Standar",
        "Biru Standar TNI AU",
        "Biru TNI AU",
        "Biru Toska",
        "Biru Tua",
        "Biru Tua Metalik",
        "Biru Tua Silver",
        "Biru Ungu",
        "Black Dove",
        "Black Mica",
        "Bright Silver",
        "Champagne",
        "Chrome Black",
        "Clear White",
        "Cokelat",
        "Cokelat Abu - abu",
        "Cokelat Hitam",
        "Cokelat KeHitaman",
        "Cokelat Kenari",
        "Cokelat Kombinasi",
        "Cokelat Metalik",
        "Cokelat Muda",
        "Cokelat Muda Metalik",
        "Cokelat Silver",
        "Cokelat Tbk",
        "Cokelat Tembakau",
        "Cokelat Tua",
        "Coklat",
        "Coklat Hitam",
        "Coklat Kombinasi",
        "Coklat Krem",
        "Coklat Kuning",
        "Coklat Metalik",
        "Coklat Muda",
        "Coklat Muda Metalik",
        "Coklat Tua Metalik",
        "Cream",
        "Creamy White",
        "Cristal Black",
        "Cyrus Blue",
        "Dark Blue",
        "Dark Blue Mica",
        "Dark Grey Mica",
        "Dark Olive",
        "Dark Olive Metallic",
        "Deep Teal",
        "Deep Teal Metalik",
        "Desert Storm Beige",
        "Diamond Blue Metalic",
        "Diamond Silver",
        "Dokumen Biru Fisik Coklat",
        "Dokumen Biru Fisik Hitam",
        "Doreng",
        "Ebony Hitam",
        "Emas",
        "Glittering Metal",
        "Gold Metalik",
        "Green",
        "Green Army",
        "Green Silver",
        "Grey",
        "Grey Metalik",
        "Grey Mica Metallic",
        "Gun grey",
        "Hijau",
        "Hijau Army",
        "Hijau Daun",
        "Hijau Gelap",
        "Hijau GLP",
        "Hijau Hitam",
        "Hijau Kombinasi",
        "Hijau Kombinasi Abu",
        "Hijau Kombinasi Hitam",
        "Hijau Kuning",
        "Hijau Metalic",
        "Hijau Metalic Nope",
        "Hijau Metalik",
        "Hijau Muda",
        "Hijau Muda Metalik",
        "Hijau Mutiara",
        "Hijau Organik",
        "Hijau Perak",
        "Hijau Putih",
        "Hijau Silver",
        "Hijau Tosca",
        "Hijau Tua",
        "Hijau Tua Metalik",
        "Hijau Tua/Lumut",
        "Hijau-Metalik",
        "Hita Merah",
        "Hitam",
        "Hitam - Abu/Silver",
        "Hitam Biru",
        "Hitam - Biru",
        "Hitam - Merah",
        "Hitam - Silver",
        "Hitam (Ex Hijau)",
        "Hitam (Kanzai)",
        "Hitam Abu",
        "Hitam Abu - abu",
        "Hitam Abu- abu",
        "Hitam Abu-abu",
        "Hitam Biru",
        "Hitam Bis Putih",
        "Hitam Coklat",
        "Hitam Coklat Muda",
        "Hitam Hijau",
        "Hitam Kanzai",
        "Hitam Kuning",
        "Hitam Les Merah",
        "Hitam Les Orange",
        "Hitam Lis Biru",
        "Hitam Lis Merah",
        "Hitam List Biru",
        "Hitam List Hijau",
        "Hitam List Merah",
        "Hitam List Orange",
        "Hitam Merah",
        "Hitam Met",
        "Hitam Metalic",
        "Hitam Metalik",
        "Hitam Mika",
        "Hitam Mika/Silver",
        "Hitam MTL",
        "Hitam Mutiara",
        "Hitam Mutiara Silver",
        "Hitam Orange",
        "Hitam Perak",
        "Hitam Pink",
        "Hitam Silver",
        "Hitam putih",
        "Hitam Silver Metalik",
        "Hitam Silver Orange",
        "Hitam Strip Kuning",
        "Hitam Strip Kuning Merah",
        "Hitam Tua Metalik",
        "Hitam/Biru",
        "Hitam/Biru Metalik",
        "Hitam-Biru",
        "HitamMerah",
        "Hitam-Silver",
        "Hiujau Metalik",
        "Htam",
        "Htam Metalik",
        "Krem",
        "Krem Coklat",
        "Kron Metalik",
        "Kuning",
        "Kuning Abu - abu",
        "Kuning Coklat Tembak",
        "Kuning Hijau",
        "Kuning Hitam",
        "Kuning Kombinasi",
        "Kuning Kombinasi Biru",
        "Kuning Mas",
        "Kuning Merah",
        "Kuning Metalik",
        "Kuning MTL",
        "Kuning Muda",
        "Kuning Muda Abu-Abu",
        "Kuning Muda Kombinasi",
        "Kuning Muda Metalik",
        "Kuning Putih",
        "Kuning Silver",
        "Kuning Ungu",
        "Kuning-Orange",
        "Magenta",
        "Matic",
        "Merah",
        "Merah abu",
        "Merah Abu - abu",
        "Merah Abu abu",
        "Merah Abu- Abu",
        "Merah Abu-Abu",
        "Merah Anggur",
        "Merah Coklat",
        "Merah Coklat Muda",
        "Merah dan Putih",
        "Merah Doft",
        "Merah Hitam",
        "Merah Kombinasi",
        "Merah Kuning",
        "Merah Magenta",
        "Merah Maroon",
        "Merah Marun",
        "Merah Metalic",
        "Merah Metalik",
        "Merah Mica",
        "Merah Mika",
        "Merah MTL",
        "Merah Muda",
        "Merah Muda Metalik",
        "Merah Mutiara",
        "Merah Mutiara/Silver",
        "Merah Orange",
        "Merah Perak",
        "Merah Putih",
        "Merah Silver",
        "Merah Solid",
        "Merah Tua",
        "Merah Tua Mutiara",
        "Merah/Silver",
        "Merah-Hitam",
        "Meran Abu - abu",
        "Moon Silver",
        "Navy Gold",
        "Orange",
        "Orange Biru",
        "Orange Campur Kuning",
        "Orange Hitam",
        "Orange Kombinasi",
        "Orange Krim",
        "Orange Kuning",
        "Orange Metalik",
        "Orange Putih",
        "Orange Silver",
        "Perak",
        "Perak Hitam",
        "Perak Metalik",
        "Pink",
        "Platinum",
        "Premium",
        "Preswent Blue",
        "Primer",
        "Puith solid",
        "Putih",
        "Putih - Orange",
        "Putih (Eks. Hitam Metalik)",
        "Putih Abu",
        "Putih Abu - abu",
        "Putih Abu - abu Moka",
        "Putih Abu-abu",
        "Putih Beige",
        "Putih Biru",
        "Putih Biru Muda",
        "Putih Bru",
        "PUTIH COKLAT",
        "Putih Comb",
        "Putih Corak Merah",
        "Putih Hijau",
        "Putih Hijau Kombinasi",
        "Putih Hitam",
        "Putih Kombiasi",
        "Putih Kombinasi",
        "Putih Kombinasi Biru",
        "Putih Kombinasi Hitam",
        "Putih List Merah",
        "Putih Merah",
        "Putih Metalik",
        "Putih Mutiara",
        "Putih Orange",
        "Putih Orchid",
        "Putih Orchid Mutiara",
        "Putih Silver",
        "Putih Solid",
        "Putih Strip Hijau",
        "Red Wine",
        "Saphire Blue",
        "Silver",
        "Silver (Ungu Metalik)",
        "Silver Abu - abu",
        "Silver Abu-Abu",
        "Silver Biru",
        "Silver Hitam",
        "Silver Kombinasi",
        "Silver Kombinasi Biru",
        "Silver Kuning",
        "Silver Machine",
        "Silver Merah",
        "Silver Metalic",
        "Silver Metalik",
        "Silver Metalik Kombinasi Abu - abu",
        "Silver MTL",
        "Silver Mutiara Metalik",
        "Silver Orange",
        "Silver Putih Metalik",
        "Silver Stone",
        "Silver Sunlight",
        "Silver Tua Titanium",
        "Silver Violet",
        "Siver Metalik",
        "Sonic Blue Metalik",
        "Squadron Blue",
        "Stealth Black",
        "Stone Grey",
        "Tetian Biru",
        "Titanium Gold",
        "Toska",
        "Ungu",
        "Ungu Hitam",
        "Ungu Metalic",
        "Ungu Metalik",
        "Ungu Putih",
        "Ungu Silver",
        "Violet",
        "Violet Hitam",
        "Violet Silver",
        "White",
        "White Blue",
        "White Gold",
        "White Redn",
        "White Silver",
      ];

      function initWarna() {
        const selectWarna = document.getElementById("warna");
        selectWarna.innerHTML =
          '<option value="">Pilih Warna Kendaraan</option>';

        daftarWarna.sort().forEach((warna) => {
          const opt = document.createElement("option");
          opt.value = warna;
          opt.textContent = warna;
          selectWarna.appendChild(opt);
        });

        $("#warna").select2({
          width: "100%",
          placeholder: "Pilih Warna Kendaraan",
        });
      }

      document.addEventListener("DOMContentLoaded", initWarna);
    </script>

    <script>
      let lokasiData = [];

      fetch("Lokasii.json")
        .then((res) => res.json())
        .then((data) => {
          lokasiData = data;
          initLokasiDropdown(data);
        });

      function initLokasiDropdown(data) {
        const select = $("#lokasi_objek");

        select.empty().append('<option value="">Pilih Lokasi Objek</option>');

        data.forEach((item) => {
          const kota = item["KOTA"];
          select.append(new Option(kota, kota));
        });

        select.select2({
          placeholder: "Cari Kota / Lokasi",
          allowClear: true,
          width: "100%",
        });
      }

      // AUTO ISI
      $(document).on("change", "#lokasi_objek", function () {
        const val = $(this).val();

        if (!val) {
          $("#provinsi").val("");
          $("#kategori_lokasi").val("");
          $("#kpknl").val("");
          return;
        }

        const data = lokasiData.find((l) => l["KOTA"] === val);

        if (!data) return;

        $("#provinsi").val(data["PROVINSI"]);
        $("#kategori_lokasi").val(data["KATEGORI LOKASI"] || "3");

        // ðŸ”¥ ambil dari kolom kosong ("")
        // âœ… ambil dari field KPKNL
        $("#kpknl").val(data["KPKNL"] || "");
      });
    </script>

    <script>
      document
        .getElementById("tahun_pembuatan")
        .addEventListener("input", function () {
          const tahun = parseInt(this.value, 10);
          const sekarang = new Date().getFullYear();

          if (tahun < 1900 || tahun > sekarang) {
            this.setCustomValidity("Tahun tidak valid");
          } else {
            this.setCustomValidity("");
          }
        });
    </script>

    <script>
      function titleCase(str) {
        return str.replace(/\b\w/g, function (txt) {
          return txt.toUpperCase();
        });
      }
      document.addEventListener("DOMContentLoaded", function () {
        document
          .querySelectorAll(
            '#kertasKerjaForm input[type="text"], #kertasKerjaForm input[list]',
          )
          .forEach(function (input) {
            input.addEventListener("input", function () {
              let start = input.selectionStart;
              let end = input.selectionEnd;
              let valBaru = titleCase(input.value);
              if (input.value !== valBaru) {
                input.value = valBaru;
                input.setSelectionRange(start, end);
              }
            });
          });
      });
    </script>
    <script>
      document.addEventListener("DOMContentLoaded", () => {
        try {
          // Ambil token satker
          const token = localStorage.getItem("jwt_satker");
          if (!token) return;

          // Parse payload JWT (pakai helper auth.js)
          const payload = (function () {
            const part = token.split(".")[1];
            const json = atob(part.replace(/-/g, "+").replace(/_/g, "/"));
            return JSON.parse(
              decodeURIComponent(
                json
                  .split("")
                  .map(
                    (c) =>
                      "%" + ("00" + c.charCodeAt(0).toString(16)).slice(-2),
                  )
                  .join(""),
              ),
            );
          })();

          const namaSatker = payload?.data?.satker;
          if (namaSatker) {
            const input = document.getElementById("pemilik_dokumen");
            if (input) input.value = namaSatker;
          }
        } catch (e) {
          console.warn("Gagal mengisi Pemilik Dokumen dari token", e);
        }
      });
    </script>

    <script>
      document.addEventListener("DOMContentLoaded", () => {
        const el = document.getElementById("welcomeName");
        if (!el) return;
        // cukup dari helper (sudah ada fallback per-role di auth.js)
        el.textContent = Auth.getName("satker") || "Pengguna";
      });
    </script>
    <script>
      function isiPemilikDokumenDariToken() {
        try {
          const token = localStorage.getItem("jwt_satker");
          if (!token) return;

          const part = token.split(".")[1];
          const json = atob(part.replace(/-/g, "+").replace(/_/g, "/"));
          const payload = JSON.parse(
            decodeURIComponent(
              json
                .split("")
                .map(
                  (c) => "%" + ("00" + c.charCodeAt(0).toString(16)).slice(-2),
                )
                .join(""),
            ),
          );

          const namaSatker = payload?.data?.satker;
          if (namaSatker) {
            document.getElementById("pemilik_dokumen").value = namaSatker;
          }
        } catch (e) {
          console.warn("Gagal isi pemilik dokumen", e);
        }
      }

      document.addEventListener("DOMContentLoaded", isiPemilikDokumenDariToken);
    </script>

    <!-- ====== LOGOUT SATKER ====== -->
    <script>
      document.addEventListener("DOMContentLoaded", () => {
        const btnLogout = document.getElementById("satkerLogout");
        if (btnLogout) {
          btnLogout.addEventListener("click", (ev) => {
            ev.preventDefault();
            try {
              Auth.logout("satker");
            } catch {}
            location.href = "daftar.html";
          });
        }
      });
    </script>

    <script>
      function openClearModal() {
        document.getElementById("clearModal").style.display = "flex";
      }

      function closeClearModal() {
        document.getElementById("clearModal").style.display = "none";
        document.getElementById("clearLoading").style.display = "none";
      }

      function confirmClearData() {
        const loading = document.getElementById("clearLoading");
        const text = document.getElementById("clearLoadingText");

        // tampilkan loading
        loading.style.display = "block";

        // animasi titik-titik
        let dot = 0;
        const anim = setInterval(() => {
          dot = (dot + 1) % 4;
          text.innerText = "Menghapus data" + ".".repeat(dot);
        }, 400);

        // delay sedikit biar smooth
        setTimeout(() => {
          clearInterval(anim);

          const form = document.getElementById("kertasKerjaForm");

          // reset form
          form.reset();

          // reset SELECT2
          $("#merek_kendaraan").val(null).trigger("change");
          $("#tipe_kendaraan").val(null).trigger("change");
          $("#lokasi_objek").val(null).trigger("change");
          $("#warna").val(null).trigger("change");

          // reset field otomatis
          document.getElementById("kategori_lokasi").value = "";
          document.getElementById("provinsi").value = "";

          // checkbox
          document
            .querySelectorAll('input[name="dokumen_kepemilikan[]"]')
            .forEach((c) => (c.checked = false));

          document.getElementById("lainnyaCheckbox").checked = false;
          document.getElementById("lainnyaInput").value = "";
          document.getElementById("lainnyaInput").style.display = "none";
          document.getElementById("tidakAdaCheckbox").checked = false;

          // CC
          document.getElementById("cc_roda2").style.display = "none";
          document.getElementById("cc_roda4").style.display = "none";

          // disable tipe
          $("#tipe_kendaraan").prop("disabled", true);

          // hapus session
          sessionStorage.removeItem("dataKertasKerja");

          isiPemilikDokumenDariToken();

          closeClearModal();
        }, 900);
      }
    </script>

    <!-- MODAL CLEAR DATA -->
    <div class="modal-backdrop" id="clearModal">
      <div class="modal">
        <h3>Hapus Data Form</h3>
        <p>Apakah Anda yakin ingin menghapus seluruh data yang sudah diisi?</p>

        <div class="modal-actions">
          <button class="btn-modal" onclick="closeClearModal()">Tidak</button>

          <button class="btn-modal primary" onclick="confirmClearData()">
            Ya, Hapus
          </button>
        </div>

        <!-- loading -->
        <div class="modal-loading" id="clearLoading">
          <div class="spinner"></div>
          <p id="clearLoadingText">Menghapus data...</p>
        </div>
      </div>
    </div>
  </body>
</html>
