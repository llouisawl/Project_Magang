<!doctype html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Monitoring Kertas Kerja | Admin e-Taksir</title>
    <link rel="stylesheet" href="Admin.css" />
  </head>
  <body>
    <header class="header">
      <div class="header-left">
        <img src="Gambar/D4.png" class="logo-kemenkeu" />
      </div>

      <div class="header-center">
        <!-- dikosongkan saja -->
      </div>

      <div class="header-right">
        <div class="profile-dropdown">
          <div class="profile-trigger" tabindex="0">
            <!-- LINGKARAN PROFIL -->
            <div class="profile-icon">
              <svg width="38" height="38" viewBox="0 0 38 38" fill="none">
                <circle cx="19" cy="19" r="19" fill="#eef7e6" />
                <path
                  d="M19 19c3.31 0 6-2.69 6-6s-2.69-6-6-6-6 2.69-6 6 2.69 6 6 6zM19 21c-4.41 0-8 2.24-8 5v2h16v-2c0-2.76-3.59-5-8-5z"
                  fill="#6fb32b"
                />
              </svg>
            </div>

            <!-- NAMA ADMIN DI BAWAH LINGKARAN -->
            <div class="admin-name" id="adminName">Admin</div>
          </div>

          <!-- DROPDOWN -->
          <div class="dropdown-content">
            <a href="#" id="btnLogoutAdmin" class="logout-link">
              <svg
                width="17"
                height="17"
                fill="none"
                viewBox="0 0 24 24"
                stroke="#e04848"
                style="margin-right: 7px"
              >
                <path
                  stroke-width="2"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a2 2 0 0 1-2 2h-3a2 2 0 0 1-2-2V7a2 2 0 0 1 2-2h3a2 2 0 0 1 2 2v1"
                />
              </svg>
              Logout
            </a>
          </div>
        </div>
      </div>
    </header>

    <main>
      <div class="container-table">
        <div class="table-header">
          <div class="title-group">
            <div class="title-with-logo">
              <img src="Gambar/siroto2.png" class="logo-siroto-title" />
              <div>
                <h2>Monitoring Kertas Kerja</h2>
                <p class="subtitle">
                  Data seluruh kertas kerja penaksiran kendaraan
                </p>
              </div>
            </div>
          </div>

          <div class="search-box">
            <svg viewBox="0 0 24 24" width="18" height="18">
              <path
                d="M21 21l-4.3-4.3m1.8-5.2a7 7 0 11-14 0 7 7 0 0114 0z"
                stroke="currentColor"
                stroke-width="2"
                fill="none"
                stroke-linecap="round"
              />
            </svg>
            <input
              type="text"
              id="searchInput"
              placeholder="Cari Nama satker, NUP, atau nama objek..."
            />
          </div>
        </div>

        <div class="table-responsive">
          <table id="kertasKerjaTable">
            <thead>
              <tr>
                <th>No</th>
                <th>Nama Satker</th>
                <th>NUP</th>
                <th>Nama Objek</th>
                <th>Jenis Kendaraan</th>
                <th>Taksiran Nilai Limit Lelang</th>
                <th>Aksi</th>
              </tr>
            </thead>
            <tbody id="kkTbody">
              <!-- diisi via JS -->
            </tbody>
          </table>

          <div
            id="emptyState"
            style="
              display: none;
              padding: 24px;
              text-align: center;
              color: #6b7280;
            "
          >
            Tidak ada data kertas kerja.
          </div>
        </div>
      </div>
    </main>

    <!-- BASE API -->
    <script src="config.js"></script>
    <!-- Auth utilities (guard + per-role token) -->
    <script src="auth.js"></script>

    <script>
      /* ===================== ROUTE GUARD (Admin only) ===================== */
      (function () {
        try {
          // Wajib token admin untuk membuka halaman ini
          Auth.protectPage("admin", "daftar.html");
        } catch (e) {}
      })();

      /* ===================== Konfigurasi & Token ===================== */
      const API =
        (typeof API_URL !== "undefined" && API_URL) ||
        (typeof API_BASE !== "undefined" && API_BASE) ||
        "";

      // ⛔ Penting: hanya pakai token ADMIN, jangan fallback ke token generik
      const TOKEN = localStorage.getItem("jwt_admin") || "";
      const HEADERS_AUTH = TOKEN ? { Authorization: `Bearer ${TOKEN}` } : {};

      const LIST_ENDPOINT = "/kertas-kerja/all"; // GET
      const VALIDATE_ENDPOINT = (id) =>
        `/kertas-kerja/validasi/${encodeURIComponent(id)}`; // PATCH (multipart, field: pdf_file)

      const CACHE_BUST = true; // tambahkan timestamp ke URL preview agar tidak di-cache

      /* ===================== Helpers ===================== */
      const $ = (q, el = document) => el.querySelector(q);
      const $$ = (q, el = document) => Array.from(el.querySelectorAll(q));
      const trimSlashR = (s) => (s || "").replace(/\/$/, "");

      function absUrl(path) {
        if (!path) return "";
        if (/^https?:\/\//i.test(path)) return path;
        const base = trimSlashR(API);
        const joined = path.startsWith("/") ? path : `/${path}`;
        return base + joined;
      }

      function fmtIDR(n) {
        const x = Number(n);
        return Number.isFinite(x) ? "Rp" + x.toLocaleString("id-ID") : "-";
      }

      function makeStatusBadge(validated) {
        return validated
          ? `<span class="status-badge status-val"><span class="status-dot"></span> Tervalidasi</span>`
          : `<span class="status-badge status-unval"><span class="status-dot"></span> Belum divalidasi</span>`;
      }

      /* ===================== Normalisasi item KK ===================== */
      function normalizeKK(it = {}) {
        const hasil = it.hasil_taksiran || {};
        const input = it.input_lelang || {};

        const rawPath =
          it.pdf_path_raw ||
          it.pdf_raw ||
          it.pdf_url ||
          it.url_pdf ||
          it.preview_pdf_url ||
          it.file_url ||
          it.pdf_path ||
          "";

        const markPath =
          it.pdf_path_mark ||
          it.pdf_mark ||
          it.pdf_marked_url ||
          it.watermarked_pdf_url ||
          "";

        const toBool = (v) => {
          if (typeof v === "boolean") return v;
          if (typeof v === "number") return v === 1;
          if (typeof v === "string") {
            const s = v.trim().toLowerCase();
            return (
              s === "true" ||
              s === "1" ||
              s === "ya" ||
              /\btervalidasi\b/.test(s)
            );
          }
          return false;
        };

        let validated =
          toBool(it.is_verified) ||
          toBool(it.isVerified) ||
          toBool(it.is_valid) ||
          toBool(it.validated) ||
          toBool(it.status_validasi) ||
          toBool(it.status);

        if (!validated) {
          const looksMarked =
            !!markPath || /validasi|watermark|wmk/i.test(String(rawPath));
          if (looksMarked) validated = true;
        }

        // helper angka yang tahan string "1.234.000"
        const pickNum = (v) => {
          if (v == null) return null;
          const n = Number(String(v).replace(/[^\d.-]/g, ""));
          return Number.isFinite(n) ? n : null;
        };

        // PRIORITAS: pembulatan → limit lelang → total/nilai
        const nilai =
          // pembulatan (baru & root & lama)
          pickNum(hasil.pembulatan_nilai_taksiran) ??
          pickNum(it.pembulatan_nilai_taksiran) ??
          pickNum(hasil.pembulatan) ??
          pickNum(it.pembulatan) ??
          // limit lelang (nested & root)
          pickNum(hasil.taksiran_nilai_limit_lelang) ??
          pickNum(it.taksiran_nilai_limit_lelang) ??
          // total / nilai taksiran (berbagai alias)
          pickNum(hasil.nilai_taksiran_total) ??
          pickNum(it.nilai_taksiran_total) ??
          pickNum(hasil.total_nilai_taksiran) ??
          pickNum(it.total_nilai_taksiran) ??
          pickNum(hasil.nilai_taksiran) ??
          pickNum(it.hasil_nilai_taksiran) ??
          0;

        return {
          nama_satker: it.nama_satker || input.nama_satker || "-",
          nup: it.nup || input.nup || "-",
          nama_objek: it.nama_objek || input.nama_objek || "-",
          jenis_kendaraan:
            it.jenis_kendaraan ||
            it.jenisKendaraan ||
            input.jenis_kendaraan || // ⬅️ dari input kendaraan
            "-",
          hasil_nilai_taksiran: Number(nilai) || 0,
          validated,
          rawUrl: absUrl(rawPath),
          markUrl: absUrl(markPath),
        };
      }

      /* ===================== Render ===================== */
      function ensureTbody() {
        let tb = $("#kkTbody");
        if (!tb) {
          const table = $("#kertasKerjaTable");
          tb = document.createElement("tbody");
          tb.id = "kkTbody";
          table.appendChild(tb);
        }
        return tb;
      }

      function renderRow(kk, idx) {
        const tr = document.createElement("tr");
        tr.dataset.id = kk.id || "";
        tr.dataset.validated = kk.validated ? "true" : "false";
        tr.dataset.rawUrl = kk.rawUrl || "";
        tr.dataset.markUrl = kk.markUrl || "";

        tr.innerHTML = `
    <td>${idx + 1}</td>
    <td>${kk.nama_satker}</td>
    <td>${kk.nup}</td>
    <td>${kk.nama_objek}</td>
    <td>${kk.jenis_kendaraan}</td>
    <td>${fmtIDR(kk.hasil_nilai_taksiran)}</td>
    <td>
      <button class="btn-preview" data-url="${kk.pdfUrl}">
        Preview
      </button>
    </td>
  `;
        return tr;
      }

      function rerenderStatus(tr) {
        const cell = tr.querySelector(".status-cell");
        const validated = (tr.dataset.validated || "false") === "true";
        if (cell) cell.innerHTML = makeStatusBadge(validated);
      }

      /* ===================== State ===================== */
      let ALL_ROWS = [];
      let VIEW_ROWS = [];

      /* ===================== Fetch list ===================== */
      async function loadKertasKerja() {
        const tbody = ensureTbody();
        const table = $("#kertasKerjaTable");
        const colCount = table.tHead?.rows[0]?.cells?.length || 7;

        tbody.innerHTML = `
          <tr>
            <td colspan="${colCount}" style="text-align:center;color:#6b7280;padding:16px">
              Memuat data…
            </td>
          </tr>`;

        try {
          const res = await fetch(trimSlashR(API) + LIST_ENDPOINT, {
            headers: { ...HEADERS_AUTH },
          });

          // Ada backend yang balas 204 No Content
          if (res.status === 204) {
            ALL_ROWS = [];
            VIEW_ROWS = [];
            tbody.innerHTML = "";
            $("#emptyState").style.display = "block";
            return;
          }

          if (!res.ok) throw new Error("HTTP " + res.status);

          const json = await res.json().catch(() => ({}));
          const list = Array.isArray(json?.data)
            ? json.data
            : Array.isArray(json?.result)
              ? json.result
              : Array.isArray(json)
                ? json
                : [];

          ALL_ROWS = list.map(normalizeKK);
          VIEW_ROWS = [...ALL_ROWS];

          // Render
          tbody.innerHTML = "";
          if (!VIEW_ROWS.length) {
            $("#emptyState").style.display = "block";
            return;
          }
          $("#emptyState").style.display = "none";
          VIEW_ROWS.forEach((kk, i) => tbody.appendChild(renderRow(kk, i)));
        } catch (e) {
          tbody.innerHTML = `
            <tr>
              <td colspan="${colCount}" style="text-align:center;color:#ef4444;padding:16px">
                Gagal memuat data. Coba refresh halaman.
              </td>
            </tr>`;
          console.error(e);
        }
      }

      /* ===================== Preview ===================== */
      function handlePreview(tr) {
        const validated = (tr.dataset.validated || "false") === "true";
        let url = validated
          ? tr.dataset.markUrl || tr.dataset.rawUrl
          : tr.dataset.rawUrl || tr.dataset.markUrl;

        if (!url) {
          alert("File PDF belum tersedia.");
          return;
        }
        if (CACHE_BUST) {
          url += (url.includes("?") ? "&" : "?") + "t=" + Date.now();
        }
        window.open(url, "_blank", "noopener");
      }

      /* ===================== Modal Upload ===================== */
      const modal = {
        el: null,
        ok: null,
        cancel: null,
        link: null,
        spin: null,
        check: null,
        msg: null,
        _objUrl: null,
        file: null,
        tr: null,
        init() {
          this.el = $("#uploadModal");
          this.ok = $("#btnOk");
          this.cancel = $("#btnCancel");
          this.link = $("#modalFileLink");
          this.spin = $("#modalSpinner");
          this.check = $("#modalCheck");
          this.msg = $("#modalMsg");

          if (this.el) {
            this.el.addEventListener("click", (e) => {
              if (e.target === this.el) this.close();
            });
          }
          if (this.ok) this.ok.addEventListener("click", () => this.confirm());
          if (this.cancel)
            this.cancel.addEventListener("click", () => this.close());
        },
        _cleanupURL() {
          if (this._objUrl) {
            URL.revokeObjectURL(this._objUrl);
            this._objUrl = null;
          }
        },
        open(file, tr) {
          if (!this.el) this.init();
          this._cleanupURL();
          this.file = file;
          this.tr = tr;
          this._objUrl = URL.createObjectURL(file);
          if (this.link) {
            this.link.textContent = file.name;
            this.link.href = this._objUrl;
          }
          if (this.msg) this.msg.textContent = "";
          if (this.spin) this.spin.style.display = "none";
          if (this.check) this.check.style.display = "none";
          if (this.ok) this.ok.disabled = false;
          if (this.cancel) this.cancel.disabled = false;
          if (this.el) {
            this.el.style.display = "flex";
            this.el.removeAttribute("aria-hidden");
          }
        },
        async confirm() {
          if (!this.ok || !this.cancel || !this.spin || !this.msg) return;
          this.ok.disabled = true;
          this.cancel.disabled = true;
          this.spin.style.display = "inline-block";
          this.msg.textContent = "Mengunggah…";

          try {
            await patchValidate(this.file, this.tr);
            this.spin.style.display = "none";
            if (this.check) this.check.style.display = "flex";
            this.msg.textContent = "Berhasil diupload";
            setTimeout(() => this.close(), 900);
          } catch (err) {
            this.spin.style.display = "none";
            this.msg.textContent = err?.message || "Gagal mengunggah file.";
            this.ok.disabled = false;
            this.cancel.disabled = false;
          }
        },
        close() {
          this._cleanupURL();
          if (!this.el) return;
          this.el.style.display = "none";
          this.el.setAttribute("aria-hidden", "true");
        },
      };

      /* ===================== Upload (Validasi) ===================== */
      async function patchValidate(file, tr) {
        const kkId = tr.dataset.id || "";
        if (!kkId) throw new Error("ID kertas kerja tidak tersedia.");

        const fd = new FormData();
        fd.append("pdf_file", file);

        const res = await fetch(trimSlashR(API) + VALIDATE_ENDPOINT(kkId), {
          method: "PATCH",
          body: fd,
          headers: { ...HEADERS_AUTH }, // jangan set Content-Type manual
        });

        if (!res.ok) {
          let msg = `Upload gagal (HTTP ${res.status})`;
          try {
            const j = await res.json();
            if (j?.message) msg = j.message;
          } catch {}
          throw new Error(msg);
        }

        let data = {};
        try {
          data = await res.json();
        } catch {}

        const payload = data?.data || data || {};
        const mark =
          payload.pdf_path_mark ||
          payload.pdf_mark ||
          payload.pdf_marked_url ||
          payload.watermarked_pdf_url ||
          payload.url ||
          "";

        if (mark) tr.dataset.markUrl = absUrl(mark);
        tr.dataset.validated = "true";
        rerenderStatus(tr);
      }

      /* ===================== Events ===================== */
      function bindTableEvents() {
        const table = $("#kertasKerjaTable");

        // Preview
        table.addEventListener("click", (e) => {
          const btnPreview = e.target.closest(".btn-preview");
          if (btnPreview) {
            const tr = btnPreview.closest("tr");
            handlePreview(tr);
          }
        });

        // Upload (open modal)
        table.addEventListener("change", (e) => {
          const input = e.target.closest(".hidden-file");
          if (!input) return;
          const tr = input.closest("tr");
          const file = input.files && input.files[0];
          if (file && tr) {
            modal.open(file, tr);
          }
          // reset agar file sama bisa dipilih lagi
          input.value = "";
        });

        // Kosongkan value sebelum buka picker (klik berulang)
        table.addEventListener("click", (e) => {
          const lblUpload = e.target.closest(".btn-upload");
          if (!lblUpload) return;
          const input = lblUpload.querySelector(".hidden-file");
          if (input) input.value = "";
        });
      }

      /* ===================== Search ===================== */
      function bindSearch() {
        const inp = $("#searchInput");
        if (!inp) return;
        inp.addEventListener("input", function () {
          const f = this.value.toUpperCase();
          const tbody = ensureTbody();
          tbody.innerHTML = "";

          VIEW_ROWS = ALL_ROWS.filter((r) => {
            const s1 = (r.nama_satker || "").toUpperCase();
            const s2 = (r.nup || "").toUpperCase();
            const s3 = (r.nama_objek || "").toUpperCase();

            return s1.includes(f) || s2.includes(f) || s3.includes(f);
          });

          if (!VIEW_ROWS.length) {
            $("#emptyState").style.display = "block";
            return;
          }
          $("#emptyState").style.display = "none";
          VIEW_ROWS.forEach((kk, i) => tbody.appendChild(renderRow(kk, i)));
        });
      }

      /* ===================== Welcome Name (Admin) ===================== */
      function setWelcomeName() {
        try {
          const name = Auth.getName("admin");
          if (name) {
            const el = document.getElementById("adminName");
            if (el) el.textContent = name;
          }
        } catch (e) {}
      }

      /* ===================== Logout (Admin only) ===================== */
      function bindLogout() {
        const btn = document.getElementById("btnLogoutAdmin");
        if (!btn) return;
        btn.addEventListener("click", function () {
          try {
            // Hanya hapus sesi admin
            Auth.logout("admin");
          } catch (e) {}
          location.href = "daftar.html";
        });
      }

      /* ===================== INIT ===================== */
      document.addEventListener("DOMContentLoaded", () => {
        // Pastikan token admin tersedia (kalau tidak, protectPage sudah redirect)
        if (!TOKEN) {
          try {
            Auth.protectPage("admin", "daftar.html");
          } catch (e) {}
          return;
        }
        ensureTbody();
        modal.init();
        bindTableEvents();
        bindSearch();
        bindLogout();
        setWelcomeName();
        loadKertasKerja();
      });
    </script>
  </body>
</html>
