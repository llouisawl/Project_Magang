<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Riwayat Kertas Kerja | e-Taksir</title>
    <link rel="stylesheet" href="Riwayat.css" />

    <!-- Auth per-role -->
    <script src="auth.js"></script>
    <script>
      // Kunci halaman untuk satker
      try {
        Auth.protectPage("satker");
      } catch (e) {}
    </script>
  </head>
  <body>
    <div class="container">
      <!-- Sidebar -->
      <aside class="sidebar">
        <div class="sidebar-header-flex">
          <img
            src="Gambar/Kemenkeu.png"
            alt="Logo Kemenkeu"
            class="logo-kemenkeu"
          />
          <div class="profile-dropdown">
            <span class="profile-icon" tabindex="0" aria-label="Menu profil">
              <svg width="38" height="38" viewBox="0 0 38 38" fill="none">
                <circle cx="19" cy="19" r="19" fill="#E8EEFB" />
                <path
                  d="M19 19c3.31 0 6-2.69 6-6s-2.69-6-6-6-6 2.69-6 6 2.69 6 6 6zM19 21c-4.41 0-8 2.24-8 5v2h16v-2c0-2.76-3.59-5-8-5z"
                  fill="#426bba"
                />
              </svg>
            </span>
            <div class="dropdown-content" role="menu">
              <a href="index.html">
                <svg
                  width="17"
                  height="17"
                  fill="none"
                  viewBox="0 0 24 24"
                  stroke="#426bba"
                  style="vertical-align: middle; margin-right: 7px"
                >
                  <rect
                    x="4"
                    y="2"
                    width="16"
                    height="20"
                    rx="2"
                    stroke="#426bba"
                    stroke-width="2"
                    fill="none"
                  />
                  <line
                    x1="8"
                    y1="6"
                    x2="16"
                    y2="6"
                    stroke="#426bba"
                    stroke-width="2"
                  />
                  <line
                    x1="8"
                    y1="10"
                    x2="16"
                    y2="10"
                    stroke="#426bba"
                    stroke-width="2"
                  />
                  <line
                    x1="8"
                    y1="14"
                    x2="14"
                    y2="14"
                    stroke="#426bba"
                    stroke-width="2"
                  />
                </svg>
                Kertas Kerja
              </a>
              <a href="Daftar.html" class="logout-link">
                <svg
                  width="17"
                  height="17"
                  fill="none"
                  viewBox="0 0 24 24"
                  stroke="#e04848"
                  style="vertical-align: middle; margin-right: 7px"
                >
                  <path
                    stroke-width="2"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a2 2 0 01-2 2H8a2 2 0 01-2-2V7a2 2 0 012-2h3a2 2 0 012 2v1"
                  />
                </svg>
                Logout
              </a>
            </div>
          </div>
        </div>

        <div class="welcome-row">
          <img src="Gambar/Logo.png" alt="Icon" class="welcome-icon" />
          <div class="welcome-text">
            <span>Selamat Datang</span>
            <h3 id="welcomeName">Dino</h3>
          </div>
        </div>

        <nav>
          <ul>
            <li>
              <a href="Riwayat.html" class="active"
                ><span>üóíÔ∏è</span> Riwayat Kertas kerja</a
              >
            </li>
          </ul>
        </nav>
      </aside>

      <!-- Main -->
      <div class="main-content">
        <div class="search-row">
          <div class="search-box">
            <span class="icon-search">
              <svg
                width="21"
                height="21"
                fill="none"
                viewBox="0 0 24 24"
                stroke="#3659b5"
                stroke-width="2"
              >
                <circle cx="11" cy="11" r="7"></circle>
                <line
                  x1="16.5"
                  y1="16.5"
                  x2="22"
                  y2="22"
                  stroke-linecap="round"
                ></line>
              </svg>
            </span>
            <input id="searchInput" type="text" placeholder="Cari" />
            <span class="icon-close" id="clearSearch" title="Bersihkan">√ó</span>
          </div>

          <a href="index.html" class="btn-tambah"
            >Tambah Kertas Kerja <span class="icon-plus">+</span></a
          >
        </div>

        <div class="riwayat-table">
          <table class="no-wrap">
            <thead>
              <tr>
                <th class="col-no">No</th>
                <th class="col-tanggal">Tanggal & Waktu Pembuatan</th>
                <th class="col-objek">Nama Objek</th>
                <th class="col-status">Status</th>
                <th class="col-aksi" style="text-align: center">Aksi</th>
              </tr>
            </thead>
            <tbody id="riwayatBody"></tbody>
          </table>
        </div>

        <img src="Gambar/Logo.png" alt="Watermark" class="watermark-bg" />
      </div>
    </div>

    <!-- ===================== MODAL HAPUS ===================== -->
    <div id="delModal" class="modal-backdrop" aria-hidden="true">
      <div class="modal">
        <h3>Hapus Kertas Kerja</h3>
        <p id="delModalInfo" class="modal-desc">Apakah Anda yakin?</p>
        <div class="modal-actions">
          <button id="delNo" class="btn-modal">Tidak</button>
          <button id="delYes" class="btn-modal primary">Ya</button>
        </div>
        <div class="modal-status">
          <div id="delSpinner" class="spinner"></div>
          <div id="delCheck" class="checkmark">‚úì</div>
        </div>
        <div id="delHint" class="modal-hint"></div>
      </div>
    </div>
    <!-- ======================================================= -->
    <script src="config.js"></script>
    <script>
      /* ===================== Helpers & Config ===================== */
      const $ = (q, el = document) => el.querySelector(q);
      const $$ = (q, el = document) => Array.from(el.querySelectorAll(q));

      // Pakai client SATKER dari auth.js agar header Authorization benar
      const SATKER = (function () {
        try {
          return new Auth.ApiClient("satker");
        } catch (e) {
          return null;
        }
      })();
      const HEAD = SATKER ? SATKER.headers() : {};
      const API = (
        typeof API_URL !== "undefined" && API_URL ? API_URL : ""
      ).replace(/\/$/, "");

      const POLL_MS = 20000; // interval auto-refresh saat tab aktif (ms)
      const CACHE_BUST = true; // true: tambahkan ?t=timestamp ke URL preview

      // set welcome name dari token satker
      try {
        const nm = Auth.getName("satker");
        if (nm) document.getElementById("welcomeName").textContent = nm;
      } catch (e) {}

      function isValidDate(d) {
        return d instanceof Date && !isNaN(d.getTime()) && d.getTime() > 0;
      }

      // Parser tanggal fleksibel (lokal)
      function parseBackendDate(v) {
        if (!v && v !== 0) return null;
        if (v instanceof Date) return isValidDate(v) ? v : null;
        if (typeof v === "number") {
          const d = new Date(v);
          return isValidDate(d) ? d : null;
        }
        if (typeof v === "string") {
          const s = v.trim();
          const m = s.match(
            /^(\d{4})-(\d{2})-(\d{2})[ T](\d{2}):(\d{2})(?::(\d{2})(?:\.\d+)?)?$/
          );
          if (m) {
            return new Date(
              +m[1],
              +m[2] - 1,
              +m[3],
              +m[4],
              +m[5],
              +(m[6] || 0)
            );
          }
          const iso = s.replace(" ", "T").replace(/(\.\d{3})\d+$/, "$1");
          const d2 = new Date(iso);
          if (isValidDate(d2)) return d2;
        }
        return null;
      }

      // --- Tambahkan di dekat helper lain ---
      const ZONE_OFFSETS_MIN = { WIB: 7 * 60, WITA: 8 * 60, WIT: 9 * 60 };
      // üëâ Ubah ini kalau backend kamu sebenarnya kirim WIB/WITA/UTC:
      const BACKEND_ZONE = "WIT"; // asumsi sekarang data datang sebagai jam WIT (UTC+9)

      // Zona waktu perangkat (user)
      function getUserIanaTZ() {
        try {
          return (
            Intl.DateTimeFormat().resolvedOptions().timeZone || "Asia/Makassar"
          );
        } catch {
          return "Asia/Makassar";
        } // WITA default
      }

      // Parser tanggal fleksibel (tanpa zona) ‚Äì sudah ada di kodenya
      // function parseBackendDate(v) { ... }  // biarkan tetap

      // Interpretasikan string dari backend sebagai "wall time" di BACKEND_ZONE,
      // lalu ubah ke UTC (ms), baru nanti ditampilkan ke zona user.
      function fromBackendWallToUTC(dateLike) {
        const d = parseBackendDate(dateLike);
        if (!d) return null;
        // d saat ini dibuat sebagai 'local Date'. Kita butuh komponennya:
        const Y = d.getFullYear(),
          M = d.getMonth(),
          D = d.getDate(),
          h = d.getHours(),
          m = d.getMinutes(),
          s = d.getSeconds();
        // Buat "waktu yang sama" di UTC lalu KURANGI offset zona backend
        // supaya hasilnya adalah momen UTC yang ekuivalen.
        const msAsUTC =
          Date.UTC(Y, M, D, h, m, s) -
          ZONE_OFFSETS_MIN[BACKEND_ZONE] * 60 * 1000;
        return new Date(msAsUTC);
      }

      // --- Ganti fungsi fmtDateTime lama dengan yang ini ---
      function fmtDateTime(value) {
        try {
          const utcDate = fromBackendWallToUTC(value);
          if (!utcDate) return "-";
          const tz = getUserIanaTZ();

          const tgl = utcDate.toLocaleDateString("id-ID", {
            day: "2-digit",
            month: "long",
            year: "numeric",
            timeZone: tz,
          });
          const jam = utcDate.toLocaleTimeString("id-ID", {
            hour: "2-digit",
            minute: "2-digit",
            hour12: false,
            timeZone: tz,
          });

          return `${tgl} | ${jam}`;
        } catch {
          return "-";
        }
      }

      function statusBadge(valid) {
        return valid
          ? '<span class="pill green">Tervalidasi</span>'
          : '<span class="pill red">Belum divalidasi</span>';
      }

      /* ===================== URL utils ===================== */
      function absUrl(path) {
        if (!path) return "";
        if (/^https?:\/\//i.test(path)) return path;
        const base = (API_URL || "").replace(/\/$/, "");
        const joined = path.startsWith("/") ? path : `/${path}`;
        return base + joined;
      }

      // Mapper ‚Äì TIDAK menganggap valid hanya karena ada mark.
      function mapRow(raw) {
        const id =
          raw.id ??
          raw.kertas_kerja_id ??
          raw.kertasKerjaId ??
          raw.uuid ??
          raw._id ??
          "";

        const rawPath =
          raw.pdf_path_raw ??
          raw.pdf_raw ??
          raw.pdf_url ??
          raw.url_pdf ??
          raw.preview_pdf_url ??
          raw.file_url ??
          raw.pdf_path ??
          "";

        const markPath =
          raw.pdf_path_mark ??
          raw.pdf_mark ??
          raw.pdf_marked_url ??
          raw.watermarked_pdf_url ??
          "";

        // parser boolean yang aman
        const toBool = (v) => {
          if (typeof v === "boolean") return v;
          if (typeof v === "number") return v === 1;
          if (typeof v === "string") {
            const s = v.trim().toLowerCase();
            if (
              s === "true" ||
              s === "1" ||
              s === "ya" ||
              /\btervalidasi\b/.test(s)
            )
              return true;
            return false;
          }
          return false;
        };

        // 1) coba semua varian flag dari backend
        let validated =
          toBool(raw.is_verified) ||
          toBool(raw.isVerified) ||
          toBool(raw.is_valid) ||
          toBool(raw.validated) ||
          toBool(raw.status_validasi) ||
          toBool(raw.status);

        // 2) fallback: jika flag belum benar tapi file sudah watermarked
        if (!validated) {
          const looksMarked =
            !!markPath ||
            /validasi|watermark|wmk/i.test(String(rawPath)) ||
            /validasi|watermark|wmk/i.test(String(markPath));
          if (looksMarked) validated = true;
        }

        const rawAbs = absUrl(rawPath || raw.pdf_path || "");
        const markAbs = absUrl(markPath || "");

        // jika mark kosong tapi raw sudah jelas watermarked ‚Üí pakai raw sebagai mark
        const finalMarkAbs =
          markAbs ||
          (validated && /validasi|watermark|wmk/i.test(rawAbs) ? rawAbs : "");

        return {
          id: String(id),
          created_at:
            raw.created_at ?? raw.tanggal_dibuat ?? raw.createdAt ?? null,
          nama_objek: raw.nama_objek ?? raw.nama ?? raw.objek ?? "-",
          status_validasi: validated,

          pdf_path_raw: rawPath || "",
          pdf_path_mark: markPath || "",
          pdf_path: raw.pdf_path ?? "",

          raw_url_abs: rawAbs,
          mark_url_abs: finalMarkAbs,
        };
      }

      // Pilih URL preview:
      // - Belum valid: RAW saja
      // - Tervalidasi: MARK, fallback RAW bila MARK kosong
      function getPreviewUrl(row) {
        if (row.status_validasi) {
          return row.mark_url_abs || row.raw_url_abs || null;
        }
        return row.raw_url_abs || null;
      }

      /* ===================== State ===================== */
      let allRows = [];
      let viewRows = [];
      let pollTimer = null;

      /* ===================== Render ===================== */
      function renderRows(rows) {
        const tbody = $("#riwayatBody");
        tbody.innerHTML = "";

        if (!rows.length) {
          tbody.innerHTML =
            '<tr><td colspan="5" style="text-align:center;padding:22px">Belum ada kertas kerja.</td></tr>';
          return;
        }

        rows.forEach((row, i) => {
          const tr = document.createElement("tr");
          tr.innerHTML = `
  <td class="text-center">${i + 1}</td>
  <td>${fmtDateTime(row.created_at)}</td>
  <td class="truncate">${row.nama_objek || "-"}</td>
  <td>${statusBadge(row.status_validasi)}</td>
  <td class="aksi-td" style="display:flex;gap:8px;justify-content:center">
    <!-- PREVIEW: teks saja, TANPA ikon -->
    <button class="aksi-btn lihat-btn" title="Preview PDF" data-id="${row.id}">
      <span>Preview</span>
    </button>

    <!-- HAPUS: ikon saja, TANPA teks -->
    <button class="aksi-btn hapus-btn aksi-icon-btn" title="Hapus" data-action="hapus" data-id="${
      row.id
    }">
      <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#e04848" stroke-width="2" aria-hidden="true">
        <polyline points="3 6 5 6 21 6"/>
        <path d="M19 6l-1 14a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2L5 6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
        <line x1="10" y1="11" x2="10" y2="17"/>
        <line x1="14" y1="11" x2="14" y2="17"/>
      </svg>
    </button>
  </td>
`;

          tbody.appendChild(tr);
        });
      }

      function applySearch() {
        const q = ($("#searchInput").value || "").toLowerCase().trim();
        if (!q) {
          viewRows = [...allRows];
          renderRows(viewRows);
          return;
        }
        viewRows = allRows.filter((r) => {
          const tanggal = fmtDateTime(r.created_at).toLowerCase();
          const nama = (r.nama_objek || "").toLowerCase();
          const status = r.status_validasi ? "tervalidasi" : "belum divalidasi";
          return nama.includes(q) || tanggal.includes(q) || status.includes(q);
        });
        renderRows(viewRows);
      }

      /* ===================== Modal Hapus ===================== */
      const delModal = {
        el: $("#delModal"),
        yes: $("#delYes"),
        no: $("#delNo"),
        info: $("#delModalInfo"),
        spin: $("#delSpinner"),
        check: $("#delCheck"),
        hint: $("#delHint"),
        open(infoText) {
          this.reset();
          this.info.textContent = infoText || "Apakah Anda yakin?";
          this.el.style.display = "flex";
          this.el.removeAttribute("aria-hidden");
          return new Promise((resolve) => {
            const onNo = () => {
              this.close();
              cleanup();
              resolve(false);
            };
            const onYes = () => {
              cleanup();
              resolve(true);
            };
            const cleanup = () => {
              this.no.removeEventListener("click", onNo);
              this.yes.removeEventListener("click", onYes);
            };
            this.no.addEventListener("click", onNo);
            this.yes.addEventListener("click", onYes);
            this.el.addEventListener(
              "click",
              (e) => {
                if (e.target === this.el) onNo();
              },
              { once: true }
            );
            document.addEventListener(
              "keydown",
              (e) => {
                if (e.key === "Escape") onNo();
              },
              { once: true }
            );
          });
        },
        loading(text = "Menghapus‚Ä¶") {
          this.spin.style.display = "inline-block";
          this.hint.style.display = "block";
          this.hint.textContent = text;
          this.yes.disabled = true;
          this.no.disabled = true;
        },
        success(text = "Berhasil dihapus") {
          this.spin.style.display = "none";
          this.check.style.display = "flex";
          this.hint.style.display = "block";
          this.hint.textContent = text;
        },
        failure(text = "Gagal menghapus") {
          this.spin.style.display = "none";
          this.check.style.display = "none";
          this.hint.style.display = "block";
          this.hint.textContent = text;
          this.yes.disabled = false;
          this.no.disabled = false;
        },
        reset() {
          this.spin.style.display = "none";
          this.check.style.display = "none";
          this.hint.style.display = "none";
          this.yes.disabled = false;
          this.no.disabled = false;
        },
        close() {
          this.el.style.display = "none";
          this.el.setAttribute("aria-hidden", "true");
        },
      };

      /* ===================== Actions ===================== */
      function previewById(id) {
        const row = allRows.find((r) => r.id === id);
        if (!row) return alert("Data tidak ditemukan.");
        const url = getPreviewUrl(row);
        if (!url) return alert("File PDF belum tersedia.");

        const finalUrl = CACHE_BUST
          ? url + (url.includes("?") ? "&" : "?") + "t=" + Date.now()
          : url;

        window.open(finalUrl, "_blank", "noopener");
      }

      async function deleteById(id) {
        const row = allRows.find((r) => r.id === id);
        if (!row) {
          alert("ID tidak ditemukan di daftar.");
          return;
        }

        const infoLine = `${row.nama_objek || "-"} ‚Ä¢ ${fmtDateTime(
          row.created_at
        )}`;
        const ok = await delModal.open(`Hapus kertas kerja ini?\n${infoLine}`);
        if (!ok) return;

        delModal.loading("Menghapus data & berkas di server‚Ä¶");

        const snapshot = [...allRows]; // optimistic
        allRows = allRows.filter((r) => r.id !== id);
        applySearch();

        const endpoint = `${API}/kertas-kerja/${encodeURIComponent(id)}`;
        try {
          const res = await fetch(endpoint, {
            method: "DELETE",
            headers: { ...SATKER.headers() },
          });
          if (res.ok) {
            delModal.success("Berhasil dihapus");
            setTimeout(() => delModal.close(), 800);
            return;
          }
          allRows = snapshot; // rollback
          applySearch();
          let detail = "";
          try {
            detail = await res.text();
          } catch {}
          delModal.failure(
            `Gagal (HTTP ${res.status}). ${detail || ""}`.trim()
          );
        } catch {
          allRows = snapshot;
          applySearch();
          delModal.failure("Kesalahan jaringan. Coba lagi.");
        }
      }

      /* ===================== Fetch ===================== */
      async function loadHistory() {
        const endpoint = `${API}/kertas-kerja/`;
        try {
          const res = await fetch(endpoint, {
            headers: { ...SATKER.headers() },
          });
          const json = await res.json().catch(() => ({}));
          const arr = Array.isArray(json?.data)
            ? json.data
            : Array.isArray(json)
            ? json
            : [];
          allRows = arr.map(mapRow);
          viewRows = [...allRows];
          renderRows(viewRows);
        } catch {
          allRows = [];
          viewRows = [];
          renderRows(viewRows);
        }
      }

      /* ===================== Auto-Refresh ===================== */
      function startPolling() {
        stopPolling();
        pollTimer = setInterval(() => {
          loadHistory();
        }, POLL_MS);
      }
      function stopPolling() {
        if (pollTimer) {
          clearInterval(pollTimer);
          pollTimer = null;
        }
      }

      /* ===================== Init ===================== */
      document.addEventListener("DOMContentLoaded", () => {
        // cari
        $("#searchInput")?.addEventListener("input", applySearch);
        $("#clearSearch")?.addEventListener("click", () => {
          $("#searchInput").value = "";
          applySearch();
        });

        // delegasi tombol preview & hapus
        $("#riwayatBody").addEventListener("click", (e) => {
          const btnPrev = e.target.closest(".lihat-btn");
          const btnDel = e.target.closest(".hapus-btn");
          if (btnPrev) previewById(btnPrev.dataset.id);
          if (btnDel) deleteById(btnDel.dataset.id);
        });

        // load awal + mulai polling
        loadHistory().then(() => startPolling());

        // refresh saat tab kembali aktif
        document.addEventListener("visibilitychange", () => {
          if (document.visibilityState === "visible") {
            loadHistory();
            startPolling();
          } else {
            stopPolling();
          }
        });
      });
    </script>
    <script>
      document.addEventListener("DOMContentLoaded", () => {
        try {
          const name = Auth.getName("satker");
          if (name) {
            const el = document.getElementById("welcomeName");
            if (el) el.textContent = name;
          }
        } catch (e) {}
      });
    </script>
  </body>
</html>
